# Project Export

This document consolidates all epics and requirements.

---

# E-001 Foundation/Core

## Intent
Establish the application foundation: auth/session, routing, error model, privacy/consent, performance budgets, telemetry, and browser support.

## In-Scope
- SSO sign-in and secure session handling (lock after inactivity)
- App shell and routing
- Error/empty/loading & retry model (no offline queues)
- Privacy & consent notices
- Performance budgets
- Browser matrix and fallbacks

## Out-of-Scope (optional)
- Offline/PWA
- Domain features (capture, review, approvals)

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 Auth & Session
- R-002 Routing & App Shell
- R-003 Error/Empty/Loading & Retry
- R-004 Privacy & Consent
- R-005 Performance Budgets
- (moved)
- R-007 Browser Matrix & Fallbacks


### Requirements

# R-001 Auth & Session

## Why
Protect user data and ensure secure access with minimal friction while maintaining enterprise security standards.

## Behavior
- **SSO Sign-in**: Enterprise IdP integration with automatic user provisioning
- **Session Management**: Auto-lock after inactivity threshold with configurable timeout
- **Security Controls**: Explicit sign-out and forced logout on server revocation
- **User Experience**: Seamless authentication with minimal login prompts
- **Access Control**: Role-based access based on enterprise directory

## Business Rules
- **Inactivity Threshold**: Configurable per organization (default: 15 minutes)
- **Session Security**: Lock session on browser close or inactivity
- **Force Logout**: Immediate logout on security policy changes
- **Access Validation**: Verify user permissions on each session refresh

## Scenarios (BDD)
Scenario: Successful SSO authentication
Given a user accesses the application
When they authenticate through enterprise SSO
Then they are automatically logged in with appropriate role permissions
And their session is established with the configured timeout

Scenario: Session locks after inactivity
Given the user is signed in
And the inactivity threshold is 15 minutes
When no interaction occurs for 15 minutes
Then the session is automatically locked
And the user is prompted to re-authenticate
And any unsaved work is preserved

Scenario: Forced logout on security policy change
Given a user has an active session
When security policies are updated by IT
Then the user is immediately logged out
And they must re-authenticate to continue
And a clear message explains the security update

Scenario: Role-based access validation
Given a user with Finance role accesses the system
When they navigate to different sections
Then they see only Finance-appropriate features
And access to other roles' functions is denied with clear messaging

Scenario: Session timeout warning
Given a user's session is approaching timeout
When they have 2 minutes remaining
Then they receive a clear warning about session expiration
And can extend their session with a simple action

## Role-based Access & Active Role (MVP)
- Role claims are issued by the IdP/back end (e.g., roles=["Traveler","Manager","Finance","IT Administrator"]).
- The client maintains an `activeRole` in session; state-changing requests include header `X-Active-Role: <role>` for audit.
- If a user navigates to a route not permitted by the current `activeRole`, show a 403 card with a CTA to switch to a permitted role (if available) and then continue.
- All privileged actions must validate both authentication and role authorization on the server; client-side checks are UX only.

## Scenarios (BDD) â€” Active Role & RBAC
Scenario: 403 with switch suggestion on unauthorized route
Given a signed-in user with roles Traveler and Manager
And their active role is Traveler
When they open a deep link to an approval `/approvals/:id`
Then a 403 card is shown with CTA "Switch to Manager to access"
And clicking the CTA switches active role to Manager and opens the approval

Scenario: Audit header on privileged action
Given a user with Finance role performs a CSV export
When the request is sent to the server
Then the request contains header `X-Active-Role: Finance`
And the server records an audit entry with userId, activeRole, action, entityId, and timestamp


# R-002 Routing & App Shell

## Why
Provide a stable layout and navigational backbone for all modules.

## Behavior
- App shell renders header/nav/content regions
- Header contains avatar menu with Global Role Switcher (visible only when user has >1 roles)
- Client-side routing with route guards; unauthorized routes show a 403 card with a role-switch CTA when applicable
- Fallback route for unknown URLs

## Scenarios (BDD)
Scenario: Guarded route redirects unauthenticated user
Given an unauthenticated user
When they navigate to /review
Then they are redirected to /signin

Scenario: Unauthorized route shows 403 with switch CTA
Given an authenticated user with roles Traveler and Manager
And active role Traveler
When they open /approvals/123
Then a 403 card is shown with CTA to switch to Manager
And selecting it switches role and opens the approval


# R-003 Error/Empty/Loading & Retry

## Why
Provide clear, actionable feedback to users for all system states while maintaining a professional user experience.

## Behavior
- **Loading States**: Show skeleton screens for content loading with <100ms appearance
- **Empty States**: Provide helpful guidance when no data is available
- **Error Handling**: Display actionable error messages with clear next steps
- **Retry Logic**: Offer retry options for recoverable errors
- **User Guidance**: Provide context-specific help and support options

## Business Rules
- **Loading Threshold**: Show loading state after 100ms delay
- **Error Categories**: Distinguish between user errors, system errors, and network issues
- **Retry Limits**: Allow up to 3 retry attempts for recoverable operations
- **Support Integration**: Provide direct access to help and support for persistent errors
- **Data Preservation**: Preserve user input during error recovery

## Scenarios (BDD)
Scenario: Loading state appears quickly
Given a user navigates to a data-heavy page
When the page starts loading
Then a loading skeleton appears within 100ms
And shows the expected content structure

Scenario: Empty state with helpful guidance
Given a user accesses a section with no data
When the page loads
Then an empty state message appears with clear guidance
And provides actionable next steps to populate the section

Scenario: Recoverable error with retry option
Given a network request fails temporarily
When the error occurs
Then a clear error message is displayed
And a retry button is provided
And the user can attempt the operation again

Scenario: Persistent error with support escalation
Given an error persists after 3 retry attempts
When all retries are exhausted
Then a support escalation message is shown
And direct access to help resources is provided
And the error details are logged for support

Scenario: User input preserved during error
Given a user is filling out a form
When a network error occurs
Then the user's input is preserved
And they can retry without re-entering data
And clear guidance is provided on the error cause


# R-004 Privacy & Consent

## Why
Comply with data protection and inform users exactly which data is collected, for what purpose, how long it is retained, and with whom it is shared.

## Behavior
- Display a data usage notice that lists: data categories collected (e.g., images, metadata, device info), purpose (capture, OCR, QA), retention period, and sharing (none/processor only). Include a link to the full policy.
- Minimal client storage (only session token and consent flags; no images cached after upload completes).
- Consent prompts for camera/files with a rationale that names the feature (Capture) and purpose (scan and extract receipt data).

## Scenarios (BDD)
Scenario: Camera permission request shows rationale
Given a user starts capture
When camera access is requested
Then a rationale is displayed
And the user can Allow or Deny


# R-005 Performance Budgets

## Why
Ensure responsive UX across devices.

## Behavior
- Define budget: LCP â‰¤ 2.5 s (p75), TTI â‰¤ 3.5 s (p75)
- List virtualization for >100 items
- CDN/cache headers for static assets

## Scenarios (BDD)
Scenario: Large list uses virtualization
Given a list with 500 receipts
When rendering the list
Then only visible rows are rendered


# R-006 Chat Privacy, Session & PII Redaction

## Why
Protect sensitive data in conversational workflows while keeping the chat usable and reliable.

## Behavior
- PII sanitizer runs on all chat uploads; redacts IBANs, card numbers, emails, and faces where required.
- Logs/telemetry store redacted content only; raw files are stored securely with access control.
- Session handling: inactivity lock applies to chat; on resume, sensitive previews are hidden until re-auth.
- In-thread error & retry model: transient failures provide clear retry actions; no offline queues.

## Scenarios (BDD)
Scenario: PII redaction on receipt upload
Given a receipt image containing an IBAN
When the user uploads it in chat
Then the stored chat preview is redacted
And the original file is stored securely with restricted access

Scenario: Session lock hides sensitive content
Given the user was inactive and the session locked
When the user returns to chat
Then sensitive message previews are hidden
And re-authentication reveals them


# R-007 Browser Matrix & Fallbacks

## Why
Provide predictable behavior across supported browsers.

## Behavior
- Support current major browsers
- Provide graceful degradation and documented fallbacks for unsupported APIs

## Scenarios (BDD)
Scenario: Unsupported API uses fallback
Given Safari lacks the preferred API
When the feature is used
Then the documented fallback is applied


# R-008 Notifications (Inâ€‘App/Email)

## Why
Notify users of specific workflow events without relying on web push.

## Behavior
- Inâ€‘app notifications center with unread count and per-item status.
- Email notifications for:
  - New approval tasks (recipient: assigned manager)
  - Report submission success/failure (recipient: submitter)
  - Reassignment of receipts (recipient: assignee)
- Each notification must include: title, event type, entity ID, timestamp in ISOâ€‘8601, and a deep link.
- No Web Push used.

## Scenarios (BDD)
Scenario: Manager receives email on new approval task
Given a report is submitted to a manager
When the submission completes
Then an email notification is sent to the manager


# R-009 Internationalization (DE/EN)

## Why
Serve German and English users consistently.

## Behavior
- All UI strings localized to DE and EN
- Locale switch in settings with instant apply
- Dates/numbers formatted per locale

## Scenarios (BDD)
Scenario: Locale switch updates UI
Given the UI language is English
When the user selects Deutsch
Then all visible strings render in German


# R-010 Settings & Preferences

## Why
Allow users to tailor basic experience and notifications.

## Behavior
- Language preference: DE/EN with instant apply
- Theme preference: Light/Dark with persistence
- Email notifications preferences: approvals, submissions (opt-in/out)

## Scenarios (BDD)
Scenario: Turn off approval emails
Given email notifications are on by default
When the user turns off Approval emails in Settings
Then new approval notifications are no longer emailed
And in-app notifications remain unaffected


### Userflows

# UF-001 Auth, Session & Consent

## Scope
- Epic: `E-001-foundation`
- Goal: Secure, low-friction sign-in with robust session handling and clear consent.
- Entry: Unauthenticated user visits any guarded route.
- Exit: User is signed in with an active session; permissions granted or declined with rationale captured.

## Personas & Context
- Traveler/Manager/Finance: Enterprise SSO, on mobile-first web.

## Flow (numbered)
1) User opens `/review` (guarded)
   - System: Redirects to `/signin` with returnUrl=/review.
2) User taps "Sign in with SSO"
   - System: Redirects to IdP; shows loading state; returns with token.
3) System establishes session
   - System: Stores session; navigates to returnUrl; renders skeleton <100 ms.
3a) Default landing (no returnUrl)
   - System: Navigates to Chat Home (default) and restores last-used view if present.
4) First camera/files access (e.g., Capture)
   - System: Shows concise rationale; asks permission (Allow/Deny).
5) Inactivity threshold reached (15 min)
   - System: Locks session; shows unlock screen; preserves unsaved UI state.
6) User unlocks (tap "Unlock" â†’ re-auth)
   - System: Silent re-auth if possible; else IdP; returns to last route or Chat Home.
7) User signs out
   - System: Clears session; returns to `/signin`.

## Screens & States
- Screen: Sign In
  - Loading: Spinner during IdP redirect/return
  - Empty: SSO button and info
  - Error: Auth error with reference code; Retry
  - Validation: Block multiple rapid taps; disable when loading
- Screen: Consent Prompt (Camera/Files)
  - Loading: none
  - Empty: Rationale text + Allow/Deny
  - Error: If denied, show how to enable later in Settings
  - Validation: Remember decision; non-blocking for other areas
- Screen: Session Lock
  - Loading: none
  - Empty: "Session locked" with Unlock button
  - Error: Re-auth failed â†’ back to Sign In
  - Validation: Return to last route on success

## Navigation
- Guarded route â†’ Sign In (unauthenticated)
- Sign In success â†’ returnUrl or Chat Home (default)
- Any screen â†’ Session Lock (timeout)
- Lock â†’ Last route (successful unlock) or Chat Home

## Components & Tokens
- Components: Button, Input, Alert/Toast, Modal, Skeleton
- Tokens: E-002 design tokens (brand blue/orange, spacing 8 pt, focus ring)

## Accessibility & Responsiveness
- A11y: Labels on inputs/buttons; focus trapped in modal; clear error semantics; keyboard navigable
- Breakpoints: Mobile-first; safe-area aware; Sign In layout centers on small screens; lock screen button large touch target

## Telemetry (optional)
- Events: auth_signin_start/success/fail, session_lock, session_unlock, permission_prompt_shown/granted/denied


---

# E-002 Design System & Components

## Intent
Provide a tokenized design system with an accessible component library and responsive rules to accelerate consistent UI delivery.

## In-Scope
- Design tokens (color, spacing, typography) incl. light/dark
- Component library (buttons, inputs, lists, modals, toasts, etc.)
- Accessibility AA conformance guidelines and checks
- Responsive rules for mobileâ€‘first

## Out-of-Scope (optional)
- Productâ€‘specific flows

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 Design Tokens
- R-002 Component Library
- R-003 Accessibility AA
- R-004 Responsive Rules


### Requirements

# R-001 Design Tokens

## Why
Ensure consistent theming and rapid UI changes.

## Behavior
- Define tokens for color (incl. brand white/orange/blue), spacing, typography
- Support Light and Dark themes with contrast AA
- Tokens consumable in code and docs

## Scenarios (BDD)
Scenario: Theme switch applies tokens
Given the app is in Light theme
When the user toggles Dark mode
Then components render using Dark token values


# R-002 Component Library

## Why
Provide reusable building blocks to speed delivery and ensure quality.

## Behavior
- Ship minimal core components first (button, input, select, table, modal, toast) â€” defer advanced components until later
- Document props, states, and a11y behavior
- Versioned releases with changelog

## Scenarios (BDD)
Scenario: Component docs include a11y behavior
Given a developer views Button docs
When reading the spec
Then keyboard and screen reader behavior is documented


# R-003 Accessibility AA

## Why
Ensure inclusive access and compliance.

## Behavior
- Meet WCAG 2.2 AA for contrast, focus, semantics
- Keyboard navigation for all interactive components
- Announce dynamic changes via ARIA where needed

## Scenarios (BDD)
Scenario: Focus visible on keyboard navigation
Given a user navigates by keyboard
When tabbing through inputs
Then focus is clearly visible on each element


# R-004 Responsive Rules

## Why
Deliver a mobileâ€‘first experience that scales to desktop.

## Behavior
- Define breakpoints and layout rules for mobile/tablet/desktop
- Use list virtualization for long lists
- Provide safe areas and hitâ€‘targets on mobile

## Scenarios (BDD)
Scenario: Mobile tabs fit within safe area
Given a device with a notch
When viewing the tabs
Then tabs are not obstructed and remain tappable


### Userflows

---

# E-003 Navigation & Deep Links

## Intent
Define IA, navigation, and deep links for mobile and desktop to enable fast task switching.

## In-Scope
- Mobile tabs: Chat, Review, Approvals, Settings; Finance appears as a top-level tab when activeRole=Finance (replaces Chat)
- Desktop leftâ€‘rail with equivalent sections
- Global Role Switcher to change active role; tabs update immediately
- Stable deep links to trip, receipt, approval task with role-switch CTA when needed
- Default home: Chat (remember last-used view) except when activeRole=Finance, then Finance dashboard is default

## Out-of-Scope (optional)
- Navigation animations beyond basics

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 Mobile Tabs & Desktop Rail
- R-002 Stable Deep Links
- R-003 Gestures & Shortcuts
- R-004 Chat as Primary Entry (Default Home)
- R-005 Global Role Switcher


### Requirements

# R-001 Mobile Tabs & Desktop Rail

## Why
Support efficient navigation across key areas.

## Behavior
- Mobile tabs: Chat, Review, Approvals, Settings
- Desktop leftâ€‘rail mirrors the sections
- Default home: Chat; remember last-used view per user

## Role-based visibility (MVP)
- Traveler: Chat, Review, Settings
- Manager: Approvals, Review (team scope), Settings
- Finance: Finance (top-level tab when activeRole=Finance; replaces Chat); otherwise reachable under Settings â†’ Finance
- IT Administrator: Settings (Admin/Configuration)
- Users with multiple roles can switch via the global Role Switcher; tabs update immediately.

## Scenarios (BDD)
Scenario: Switch between tabs
Given the user is on Chat
When the user taps Review
Then the Review section is shown

Scenario: Manager sees Approvals, Traveler does not
Given a user with only Traveler role
When they open the app
Then the Approvals tab is hidden

And given a user with Manager role active
When they open the app
Then the Approvals tab is visible

Scenario: Deep link offers role switch
Given a user with Manager role available but active role is Traveler
When they open `/approvals/:id`
Then a 403 card shows with CTA to switch to Manager
And tapping it switches role and opens the approval


# R-002 Stable Deep Links

## Why
Enable direct access to specific entities for users and emails.

## Behavior
- Stable routes for trip, receipt, approval task
- Open correct view and highlight the entity
- Preserve auth guard and fallback to signâ€‘in
- Role-aware guard: if the current active role lacks permission, show a 403 card with CTA to switch to a permitted role and then continue
- Chat context chip: deep links can open chat focused on an entity and show a context chip (trip/receipt/approval)

## Scenarios (BDD)
Scenario: Open receipt deep link
Given the user is signed in
When visiting /receipts/123
Then the receipt 123 is displayed and highlighted

Scenario: Role switch CTA on approval deep link
Given the user has Manager role but active role is Traveler
When visiting /approvals/456
Then a 403 card is shown with CTA "Switch to Manager"
And selecting it switches role and opens the approval 456

Scenario: Role switch CTA on Finance deep link
Given the user has Finance role but active role is Traveler
When visiting /finance/dashboard
Then a 403 card is shown with CTA "Switch to Finance"
And selecting it switches role and opens the Finance dashboard


# R-003 Gestures & Shortcuts

## Why
Speed up frequent navigation and actions on mobile and desktop.

## Behavior
- Mobile: swipe left/right to switch tabs; respect system back gesture
- Desktop: keyboard shortcuts for primary actions (e.g., Ctrl+K to command palette/search, C to focus Chat, G then R to go to Review)
- Provide a shortcuts help overlay (e.g., ? key) listing available shortcuts
- When `activeRole=Finance` and Chat is not present in the tab bar, pressing C still opens Chat via the shortcut overlay and focuses the input

## Scenarios (BDD)
Scenario: Swipe between tabs on mobile
Given the user is on the Chat tab on a mobile device
When they swipe left
Then the Review tab becomes active

Scenario: Keyboard shortcut to open search
Given the user is on desktop
When they press Ctrl+K
Then the command palette/search opens

Scenario: Shortcut to focus Chat
Given the user is on desktop
When they press C
Then Chat becomes focused and ready for input

Scenario: Chat shortcut when Finance is active
Given `activeRole=Finance` and Chat is not present in the tab bar
When the user presses C on desktop
Then the shortcut overlay opens Chat and focuses the input

## Accessibility (WCAG)
- Map to WCAG 2.2: 2.4.3 Focus Order; 2.1.1 Keyboard; 4.1.2 Name, Role, Value; 3.3.2 Labels or Instructions


# R-004 Chat as Primary Entry (Default Home)

## Why
Make AI chat the main way to work: faster capture, Q&A, and commands, with detail screens as secondary.

## Behavior
- Chat opens by default on mobile and desktop (Option A); last-used view is remembered per user.
- Exception: When activeRole=Finance, Finance is a top-level tab and becomes the default home for the session; Chat remains accessible via navigation and shortcuts.
- Global access: chat is available from tabs/rail and via keyboard shortcut.
- Deep links reopen chat with the relevant context (trip/receipt/approval) and show a context chip.
- Chat supports attaching files (images/PDF) and quick actions (Submit, Assign, Move) inline.
- Accessibility: full keyboard navigation, screen-reader labels on message actions.

## Scenarios (BDD)
Scenario: Open app shows chat home
Given a signed-in user
When the user opens the app
Then the chat view is shown by default
And the user can start typing or attach a file

Scenario: Remember last-used view
Given the user switched from Chat to Review
When the user returns later
Then the Review view opens
And the user can re-open Chat via the rail/tab

Scenario: Deep link reopens chat context
Given a deep link to a specific trip
When the user follows the link
Then the chat opens focused on that trip context
And a context chip shows the trip name

Scenario: Finance role default home is Finance dashboard
Given a signed-in user with Finance role is active
When the user opens the app
Then the Finance dashboard is shown by default
And Chat remains accessible via navigation and shortcuts


# R-005 Global Role Switcher

## Why
Support users who hold multiple roles (e.g., Traveler + Manager) by allowing quick switching of the active role to show the correct navigation and permissions.

## Behavior
- Control location: avatar menu in the top app bar labeled "Active role"; appears only when user has >1 roles.
- Options reflect assigned roles: Traveler, Manager, Finance, IT Administrator.
- Default restores last used role per device; switching updates visible tabs/routes immediately without reload.
- Routing guard: when opening a route not allowed by the current active role, show 403 card with CTA to switch to a permitted role.
- Finance IA: when switching to Finance, the Finance tab replaces Chat for the session; switching away restores Chat.
- Telemetry: track role_switch_opened, role_selected, role_switch_completed.

## Scenarios (BDD)
Scenario: Switch role updates navigation
Given a user has roles Traveler and Manager
And their active role is Traveler
When they select Manager from the Role Switcher
Then the Approvals tab becomes visible and Chat is hidden

Scenario: Restore last role
Given a user set Manager as active role previously on this device
When they reopen the app
Then Manager is active and the corresponding tabs/routes are shown

Scenario: 403 with switch CTA
Given a user has roles Traveler and Manager
And their active role is Traveler
When they open an Approvals deep link
Then a 403 card is shown with a "Switch to Manager" CTA
And selecting it switches role and navigates to the approval

Scenario: Switching to Finance replaces Chat with Finance tab
Given a user has roles Traveler and Finance
And their active role is Traveler
When they select Finance from the Role Switcher
Then the Finance tab appears and Chat is removed from the tab bar for the session
And deep links to Chat remain accessible via shortcuts


### Userflows

# UF-003 Navigation: Tabs, Gestures & Deep Links

## Scope
- Epic: `E-003-navigation-ia`
- Goal: Let users switch areas fast on mobile; open deep links reliably.
- Entry: App launch or following a deep link.
- Exit: Target section visible; correct entity focused.

## Personas & Context
- All roles; mobile-first with gestures; desktop left-rail parity.

## Flow (numbered)
1) App launch â†’ default view
   - System: If `activeRole=Finance`, open Finance dashboard; else open Chat by default. If a last-used view exists, restore it.
2) User presses global Chat key (e.g., C) or taps Chat icon
   - System: Brings Chat to foreground from any section; preserves context. If Finance is active and Chat is not in the tab bar, Chat opens via shortcut overlay.
3) User swipes left
   - System: Switches to "Review"; announces change for SR.
4) User taps "Review" tab
   - System: Navigates to Review list; persists last view per user.
5) Email arrives with receipt link `/receipts/123`
   - User taps deep link
   - System: Auth guard; if signed in â†’ opens receipt detail; highlights card; Chat shows a context chip when invoked.
6) Deep link to approval `/approvals/456` while active role is Traveler
   - System: Shows 403 card with CTA "Switch to Manager"; on confirm, switches role and opens the approval.
7) Deep link to finance `/finance/dashboard` while active role is Traveler
   - System: Shows 403 card with CTA "Switch to Finance"; on confirm, switches role and opens Finance dashboard.

## Screens & States
- Screen: App Shell + Tabs/Rail + Chat entry
  - Loading: Top-level skeleton for initial route
  - Empty: N/A
  - Error: Route-not-found â†’ fallback route
  - Validation: Safe-area tabs; min hit targets 44 px
- Screen: Shortcuts Overlay (desktop)
  - Loading: none
  - Empty: List of shortcuts
  - Error: none

## Navigation
- Sections: Chat (primary; replaced by Finance when `activeRole=Finance`) â†” Review â†” Approvals â†” Settings
- Deep links: `/trips/:id`, `/receipts/:id`, `/approvals/:id`, `/finance/dashboard`, `/chat?trip=:id`
- Back gesture respected on mobile; keyboard shortcuts on desktop

## Components & Tokens
- Components: TabBar, Rail (desktop), Toast, ShortcutOverlay, ChatEntry
- Tokens: Spacing for safe areas; contrast AA for selected tab

## Accessibility & Responsiveness
- A11y: Tabs are role="tablist"; ARIA-selected on current; announce tab changes; Chat entry reachable via keyboard and SR labeled
- Breakpoints: TabBar on mobile; left-rail on â‰¥ lg; maintain focus order

## Telemetry (optional)
- Events: nav_app_launch, nav_chat_open, nav_tab_switch, deeplink_open, role_switch_cta_shown, role_switch_cta_accepted, shortcut_overlay_open


# UF-003 Wireframes â€” Navigation, Tabs, Deep Links

## Scope
- Epic: `E-003-navigation-ia`
- Goal: Show key screens/states for navigation, role switching, and deep links with Finance IA.

## Mobile â€” Tab Bar (default role â‰  Finance)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App Bar       [Search]   [Avatar â–¾] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                       â”‚
â”‚            Chat Home Content          â”‚
â”‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Chat â—]   [Review]   [Approvals] [âš™] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Selected indicator â— on current tab (AA contrast)
- Keyboard: C focuses Chat input

## Mobile â€” Tab Bar (activeRole=Finance â†’ Finance replaces Chat)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App Bar       [Search]   [Avatar â–¾] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                       â”‚
â”‚           Finance Dashboard            â”‚
â”‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Finance â—] [Review]   [Approvals] [âš™] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Chat not in tab bar; still reachable via shortcut overlay

## Desktop â€” Left Rail
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Chat/Finance]                                             â”‚
â”‚ [Review]                                                   â”‚
â”‚ [Approvals]                                                â”‚
â”‚ [Settings]                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Rail        â”‚  Content (Chat or Finance Dashboard)        â”‚
â”‚              â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Rail mirrors tabs; Finance replaces Chat entry when active

## Shortcuts Overlay (desktop)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Shortcuts ( ? ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ C  â†’ Focus Chat                                   â”‚
â”‚ G,R â†’ Go to Review                                â”‚
â”‚ G,A â†’ Go to Approvals                             â”‚
â”‚ /   â†’ Search / Command Palette                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- When Finance is active and Chat is not in the tab bar, C still opens Chat

## 403 Card with Role-Switch CTA
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 403: Not allowed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ You need Manager role to open this approval.     â”‚
â”‚ [Switch to Manager]   [Cancel]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Variant: "Switch to Finance" for Finance routes

## Deep Link â€” Entity Highlight
```
â”Œâ”€â”€â”€â”€ Receipt Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Back]  Receipt #123   Status: Approved          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  [Card highlighted for 2s]                        â”‚
â”‚  ...                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Chat context chip appears when deep link re-opens via Chat

## States
- Loading: Skeleton for rails/tabs; content skeleton per screen
- Empty: Clear guidance per section (no data)
- Error: Inline error + Retry; route-not-found â†’ fallback

## Components
- AppBar, AvatarMenu (with Role Switcher), TabBar, Rail, Toast, ShortcutOverlay, 403Card

## Accessibility
- Tabs role="tablist"; ARIA-selected on active
- Announce tab changes; focus management between rail and content

## Telemetry
- nav_app_launch, nav_tab_switch, deeplink_open, role_switch_cta_shown, role_switch_cta_accepted, shortcut_overlay_open


---

# E-004 Capture UX

## Intent
Enable fast, reliable receipt capture and upload via chat-only capture (no standalone capture page), without offline queues.

## In-Scope
- File attach in Chat composer with camera hint (mobile)
- Multiâ€‘upload via Chat composer with client compression (200â€“400 KB target)
- Autoâ€‘rotate/deâ€‘skew; per-item progress & cancel in-thread
- Duplicate check at capture (Assign anyway / Merge / View match) in-thread
- Streaming OCR status and suggestions in chat

## Out-of-Scope (optional)
- Offline/PWA; background sync
- Standalone Capture page/tab
- OS Share integration on mobile (post-MVP)

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 File Picker + Camera Hint (Chat composer attach)
- R-002 Multiâ€‘Upload (Chat composer)
- R-003 Client Compression
- R-004 Autoâ€‘Rotate & Deâ€‘skew
- R-005 Progress & Cancel
- R-006 Duplicate Check at Capture
- R-008 Conversational Capture & Upload (Chat)
- R-009 Chat-based Receipt Reassignment & Edits


### Requirements

# R-001 File Picker + Camera Hint

## Why
Guide users to capture receipts quickly and reliably directly from the chat composer with clear file requirements and validation.

## Behavior
- **File Support**: Chat composer attach supports images (JPG, PNG, HEIC) and PDF files
- **Camera Integration**: Mobile shows camera option with permission rationale in attach menu
- **File Validation**: Show supported file types and size limits inline in composer
- **User Guidance**: Provide clear feedback on file requirements and capture tips
- **Permission Handling**: Graceful handling of camera permission denial

## Business Rules
- **File Types**: Accept JPG, PNG, HEIC, PDF formats
- **File Size**: Maximum 10MB per file before compression
- **Image Quality**: Minimum 800x600 pixels for OCR processing
- **Permission Flow**: Request camera permission with clear business justification
- **Fallback Options**: Provide alternative capture methods if camera unavailable

## Scenarios (BDD)
Scenario: Mobile device shows camera hint in chat
Given a mobile device
When opening the chat attach menu
Then a camera option is displayed with clear label
And selecting it opens the camera with permission rationale
And the rationale explains why camera access is needed

Scenario: File type validation with clear feedback
Given a user selects an unsupported file type
When they attempt to attach the file
Then clear feedback is provided on supported formats
And alternative file options are suggested
And the user can select a different file

Scenario: File size validation and compression hint
Given a user selects a file larger than 10MB
When they attempt to attach the file
Then a size limit message is displayed
And compression options are suggested
And the user can choose to compress or select a smaller file

Scenario: Camera permission denied handling
Given a user denies camera permission
When they try to use the camera option
Then a clear message explains the impact
And alternative capture methods are provided
And guidance is given on how to enable camera access

Scenario: HEIC file handling on unsupported browsers
Given a user uploads a HEIC file on an unsupported browser
When the file is processed
Then the system automatically converts it to JPG
And the user is informed of the conversion
And the original file format is noted in the audit


# R-002 Multiâ€‘Upload

## Why
Speed up bulk capture.

## Behavior
- Select multiple files in one action from the chat composer attach
- Show perâ€‘file status inline in the chat thread (Uploading â†’ Processed)
- Allow cancel/retry per file directly in-thread

## Scenarios (BDD)
Scenario: Select multiple files in chat
Given the user selects 3 files via the chat attach menu
When uploading begins
Then 3 items appear with individual progress indicators in the thread
And each item supports cancel/retry


# R-003 Client Compression

## Why
Reduce upload time and bandwidth.

## Behavior
- Compress images to a configured target that balances speed and legibility
- Maintain EXIF orientation when needed
- Provide before/after size info

## Scenarios (BDD)
Scenario: Compression meets target size
Given a 3 MB image
When compression runs
Then the resulting file is between 200 and 400 KB


# R-004 Autoâ€‘Rotate & Deâ€‘skew

## Why
Improve OCR accuracy and readability.

## Behavior
- Autoâ€‘rotate based on EXIF/heuristics
- Deâ€‘skew mild perspective distortions
- Preserve original file when: (a) user toggles "Keep original" in settings, or (b) automatic correction confidence is below a configured threshold.

## Scenarios (BDD)
Scenario: Skewed image is corrected
Given a skewed receipt image
When processing completes
Then the preview shows a deâ€‘skewed version


# R-005 Progress & Cancel

## Why
Provide control and transparency during upload.

## Behavior
- Show perâ€‘file progress %
- Allow cancel per file and for all
- Display final success or error state per file

## Scenarios (BDD)
Scenario: Cancel a single upload
Given 2 files are uploading
When the user cancels file A
Then file A stops and file B continues


# R-006 Duplicate Check at Capture

## Why
Prevent duplicate receipts from being processed while giving users control over how to handle potential duplicates.

## Behavior
- **Automatic Detection**: System automatically checks for duplicates during upload
- **User Choice**: Present clear options: Assign Anyway, Merge, or View Match
- **Confidence Display**: Show duplicate confidence level with supporting evidence
- **Quick Resolution**: Allow users to resolve duplicates inline without leaving chat
- **Audit Trail**: Track all duplicate resolution decisions for compliance

## Business Rules
- **Duplicate Threshold**: Flag receipts with >80% similarity as potential duplicates
- **Confidence Levels**: Display confidence as High (90%+), Medium (80-89%), Low (70-79%)
- **Resolution Options**: Always provide Assign Anyway, Merge, and View Match choices
- **Audit Requirements**: Log all duplicate decisions with user attribution and timestamp
- **Data Preservation**: Ensure no data loss during merge operations

## Scenarios (BDD)
Scenario: High confidence duplicate detected
Given a receipt is uploaded
When the system detects a 95% similarity match
Then a high confidence duplicate warning is displayed
And the user sees clear evidence of the match
And all resolution options are presented

Scenario: User chooses to merge duplicates
Given a duplicate is detected with 85% confidence
When the user selects Merge option
Then the system combines the receipts intelligently
And the user is shown a summary of the merge
And the original receipt is marked as merged

Scenario: User assigns duplicate anyway
Given a duplicate is detected
When the user selects Assign Anyway
Then the receipt is processed normally
And a note is added about the duplicate decision
And the audit trail records the user's choice

Scenario: User views duplicate match details
Given a duplicate is detected
When the user selects View Match
Then detailed comparison is shown
And the user can see exact matching fields
And they can make an informed decision

Scenario: Low confidence duplicate handling
Given a receipt has 75% similarity to existing receipts
When the duplicate check runs
Then a low confidence warning is shown
And the user is advised to review carefully
And all resolution options remain available


# R-007 HEIC Handling

## Why
Ensure compatibility across devices and browsers.

## Behavior
- HEIC uploads are converted seamlessly to a widely compatible format
- Maintain consistent output quality and size targets
- Indicate conversion in audit metadata

## Scenarios (BDD)
Scenario: Unsupported browser uses server fallback
Given the user uploads a HEIC file on an unsupported browser
When the upload starts
Then the server performs conversion
And the resulting JPEG is processed


# R-008 Conversational Capture & Upload (Chat)

## Why
Let users upload receipts directly in chat and complete assignment without leaving the conversation.

## Behavior
- Attach images/PDF to a chat message; system shows in-thread processing states: uploading â†’ OCR â†’ classified.
- Duplicate detection runs; offer Assign, Merge, or Dismiss choices inline.
- User can assign to trip/day/category within the thread; confirmation message with summary and undo.
- File limits and supported types are shown; large files get client compression hints.
- Errors are presented in-thread with retry guidance; no offline queues.

## Scenarios (BDD)
Scenario: Upload and assign receipt in chat
Given the user is in chat
And attaches a receipt image
When OCR completes
Then the system suggests a trip/day and category
And if a duplicate is detected, the user can choose Assign, Merge, or Dismiss
And upon Assign, a confirmation message is posted with an undo action


# R-009 Chat-based Receipt Reassignment & Edits

## Why
Enable natural-language commands in chat to move or edit receipts quickly.

## Behavior
- Supported intents: move receipt between trips/days, change category/amount/date, add note.
- Disambiguation: the assistant asks for clarifying details if multiple matches exist.
- Confirmation: the assistant summarizes the change and asks to confirm before applying.
- Audit: chat message links to the receipt and logs who confirmed the change and when.

## Scenarios (BDD)
Scenario: Move a receipt to another trip via chat
Given a receipt assigned to Trip A
When the user says "Move the taxi receipt from Berlin to Trip B"
Then the assistant asks to confirm the specific receipt if ambiguous
And upon confirmation, the receipt is assigned to Trip B
And a confirmation with an audit link is posted in the thread


### Userflows

# UF-004 Capture & Upload

> Note: Out-of-Scope for MVP. Capture is chat-only. This flow is retained as a future optional page pattern. For MVP, see `UF-004-conversational-capture-and-commands.md`.

## Scope
- Epic: `E-004-capture`
- Goal: Fast, reliable capture/upload with dedupe and clear status.
- Entry: (Future) User opens an Upload Queue screen from navigation; in MVP, users attach in Chat (see conversational flow).
- Exit: Files uploaded/processed or duplicates resolved.

## Personas & Context
- Traveler on mobile; also desktop drag/drop.

## Flow (numbered)
1) User taps "+ Add receipts" (or comes from Chat after attaching files)
   - System: Opens file picker (accept images/PDF); shows camera hint on mobile. From Chat, preselects attached files.
2) User selects multiple files (e.g., 3)
   - System: Enqueues items; shows per-file rows (Queued â†’ Uploading).
3) Client compression runs
   - System: Compresses images to 200â€“400 KB; preserves EXIF orientation; shows before/after size.
4) Auto-rotate & de-skew
   - System: Applies corrections; preview updates.
5) Progress & cancel
   - System: Per-file percent; Cancel buttons per row and All; errors inline with Retry.
6) Duplicate check triggers on file 2
   - System: Shows duplicate warning (Assign anyway / Merge / View match); user picks Merge.
7) HEIC upload on unsupported browser
   - System: Falls back to server conversion; indicates in audit metadata.
8) Completion
   - System: Success state per file; Ready to assign or review.

## Screens & States
- Screen: Capture â€“ Upload Queue
  - Loading: Skeleton of rows <100 ms
  - Empty: "No receipts yet" + primary CTA to add
  - Error: Per-file error with code; Retry; global error banner if needed
  - Validation: Accept types; size limits; cancel behavior confirmed
- Screen: Duplicate Resolution Modal
  - Loading: Matching preview
  - Empty: n/a
  - Error: If merge fails â†’ keep both + note
  - Validation: Record resolution and actor in audit

## Navigation
- Capture queue â†’ Review (after uploads) or stay in Capture
- View match â†’ opens existing receipt detail; back returns to queue

## Components & Tokens
- Components: FilePicker, UploadRow, ProgressBar, Button, Modal, Toast, Preview
- Tokens: E-002 tokens; focus rings; color for states (success/warn/error)

## Accessibility & Responsiveness
- A11y: Announce upload start/complete; buttons keyboard accessible; modal focus trap
- Breakpoints: List virtualization on large queues; mobile-first layout with large tap targets

## Telemetry (optional)
- Events: capture_files_selected(count), upload_start, upload_error(code), duplicate_detected, duplicate_resolved(action), heic_fallback_used


# UF-004 Conversational Capture & Commands (Chat)

## Scope
- Epic: `E-004-capture`
- Goal: Let users upload, classify, and manage receipts fully within chat, using natural-language commands.
- Entry: App opens to Chat (default home) or user navigates to Chat; user attaches a file or types a command.
- Exit: Receipt assigned/edited/merged with confirmation, or command executed (e.g., create trip, submit trip) with audit link.

## Personas & Context
- Traveler: mobile-first, uploads photos/PDFs; wants quick assignment and minimal typing.
- Approver: receives approval cards in chat; can approve/reject with note.
- Finance: monitors errors/duplicates; may resolve via chat actions.

## Flow (numbered)
1) User attaches a receipt (image/PDF) or types a command (e.g., "Create a trip to Berlin next Monday").
2) System posts a message bubble with file thumbnail and status: Uploading â†’ OCR â†’ Classified.
3) System extracts vendor/date/amount/currency/category; proposes assignment (trip/day) and shows confidence.
4) If potential duplicate(s) found, system shows inline choices: Assign, Merge, Dismiss; "View match" opens details.
5) User selects an option or adjusts via quick chips (Change Trip, Change Day, Change Category) or types a correction.
6) System confirms action with a summary (receipt â†’ trip/day/category), posts an Undo for 10 minutes, and logs audit link.
7) For commands:
   - Create Trip: system asks minimal clarifications (destination/dates/purpose) if missing, creates trip, returns chip to "Open Trip".
   - Move Receipt: disambiguates target/receipt if needed, summarizes and asks to Confirm; upon Yes, applies and confirms.
   - Add Note: attaches note to the trip/receipt context with attribution.
   - Submit Trip: validates readiness; if missing items, posts checklist with quick-fix actions; upon fix, confirms submission.
8) Errors (upload fail/OCR fail/API fail): show inline error with retry; provide compression hint for large files. No offline queues.
9) Accessibility: keyboard shortcuts for attach (Ctrl/Cmd+U), quick actions reachable via Tab; screen-reader labels on actions.

## Screens & States
- Screen: Chat Home
  - Loading: skeleton bubbles for recent messages.
  - Empty: prompt suggestions ("Attach a receipt", "Create a trip", "Whatâ€™s missing for Berlin trip?").
  - Error: inline error bubble with retry and reference code.
  - Validation: disambiguation prompts for ambiguous commands; confirmation required for destructive changes.
- Screen: Receipt Match Details (modal/panel)
  - Loading: skeleton list of matches.
  - Empty: no matches â†’ suggest Assign to a new trip.
  - Error: show fetch error with retry.
  - Validation: single-select required before proceeding.

## Navigation
- From: Chat Home (Attach) â†’ To: Chat Home (Processing â†’ Result)
- From: Chat Home (View match) â†’ To: Receipt Match Details (if user wants to inspect duplicates)
- From: Chat Home (Open Trip) â†’ To: Trip Details

## Components & Tokens
- Components: LLMChatBubble, ReceiptCard (processing/ready/error), PolicyBadge, TripProgressStepper (inline), FlowButton.
- Tokens: brand-blue #005596, orange #ff7d00, 8pt grid, Roboto.

## Accessibility & Responsiveness
- A11y: focus order Chat Input â†’ Attach Button â†’ Last Message Actions; announce status changes (uploading â†’ classified) via aria-live.
- Breakpoints: mobile bottom sheet for details; desktop side panel; chat remains primary on all devices.

## Telemetry (optional)
- Events: chat_upload_started, chat_ocr_completed, chat_duplicate_detected, chat_assign_confirmed, chat_command_executed.


---

# E-005 Receipt Inbox

## Intent
Provide an inbox of unassigned receipts with fast triage and duplicate management.

## In-Scope
- Dragâ€‘andâ€‘drop assignment to trips/days
- Batch select and assign
- Confidence and duplicate flags
- Duplicates section with confirm/dismiss flow

## Out-of-Scope (optional)
- OCR pipeline internals

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 Dragâ€‘andâ€‘Drop Assignment
- R-002 Batch Select
- R-003 Confidence & Duplicate Flags
- R-004 Duplicates Section (Confirm/Dismiss)


### Requirements

# R-001 Dragâ€‘andâ€‘Drop Assignment

## Why
Speed up classification of unassigned receipts through intuitive visual assignment while maintaining data accuracy and audit trails.

## Behavior
- **Visual Assignment**: Drag receipt to trip/day to assign with clear drop targets
- **Feedback System**: Provide immediate visual feedback and success confirmation
- **Undo Functionality**: Allow undo of last assignment within 10 seconds
- **Batch Operations**: Support multiple receipt assignments in single operation
- **Validation**: Prevent invalid assignments with clear error messages

## Business Rules
- **Assignment Validation**: Only allow assignments to valid trips and dates
- **Undo Timeout**: 10-second window for assignment reversal
- **Audit Trail**: Log all assignment changes with user attribution and timestamp
- **Data Integrity**: Ensure receipt totals update immediately after assignment
- **Permission Check**: Verify user has permission to assign to target trip

## Scenarios (BDD)
Scenario: Successful drag and drop assignment
Given a receipt is in the Inbox
When the user drags it onto Trip A / Day 1
Then the receipt is assigned there with visual confirmation
And the Inbox count decreases by one
And the trip totals update immediately
And an undo option appears for 10 seconds

Scenario: Invalid assignment prevented
Given a user attempts to drag a receipt to an invalid target
When the drop target is not a valid trip or date
Then the assignment is prevented
And a clear error message explains why
And the receipt returns to its original position

Scenario: Undo assignment within timeout
Given a receipt was assigned to Trip A
When the user clicks undo within 10 seconds
Then the assignment is reversed
And the receipt returns to the Inbox
And the trip totals are updated accordingly
And the audit trail records the reversal

Scenario: Batch assignment of multiple receipts
Given multiple receipts are selected in the Inbox
When the user drags the selection to a trip
Then all selected receipts are assigned to that trip
And individual undo options are provided for each
And bulk confirmation is shown

Scenario: Assignment permission validation
Given a user attempts to assign a receipt to Trip B
When the user lacks permission for Trip B
Then the assignment is blocked
And a clear permission error is displayed
And guidance is provided on how to request access


# R-002 Batch Select

## Why
Allow bulk actions for faster triage.

## Behavior
- Multiâ€‘select receipts by checkbox or shiftâ€‘click
- Batch assign to target trip/day
- Batch delete/dismiss with confirmation

## Scenarios (BDD)
Scenario: Batch assign
Given 3 receipts are selected
When the user assigns them to Trip A / Day 2
Then all 3 receipts move to that destination


# R-003 Confidence & Duplicate Flags

## Why
Expose OCR reliability and duplication risk.

## Behavior
- Display OCR confidence indicator
- Flag potential duplicates visually
- Tooltip shows raw text and confidence details

## Scenarios (BDD)
Scenario: Low confidence is visible
Given a receipt with low OCR confidence
When viewing the Inbox card
Then a lowâ€‘confidence badge is shown


# R-004 Duplicates Section (Confirm/Dismiss)

## Why
Require explicit review of suspected duplicates.

## Behavior
- Dedicated Duplicates section in Inbox
- Confirm as duplicate or Dismiss as not a duplicate
- Keep audit of decision and actor

## Scenarios (BDD)
Scenario: Dismiss a false positive
Given a receipt appears in Duplicates
When the user dismisses it
Then it is removed from Duplicates and returns to Inbox


### Userflows

# UF-005 Receipt Inbox Triage

## Scope
- Epic: `E-005-receipt-inbox`
- Goal: Quickly assign receipts to trips/days with clarity on confidence and duplicates.
- Entry: User opens Inbox; alternatively arrives from Chat via "View in Inbox" on a duplicate prompt.
- Exit: Receipts assigned or reviewed (duplicates confirmed/dismissed).

## Personas & Context
- Traveler/Reviewer on desktop and mobile.

## Flow (numbered)
1) Inbox loads
   - System: Shows cards with thumbnail, amount, date, confidence badge.
2) User drags a receipt onto Trip A / Day 1
   - System: Highlights drop zone; on drop â†’ assigns; shows success toast; Inbox count decrements.
3) User selects 3 receipts (batch)
   - System: Batch bar appears; user chooses Assign â†’ Trip B / Day 2; all move; undo option (10 s).
4) Receipt appears in Duplicates section
   - System: Shows Duplicates tab; user opens; reviews pair; taps Dismiss false positive. From Chat, simple duplicates can be resolved inline without opening Inbox.
5) Low confidence receipt
   - System: Tooltip reveals raw text and per-field confidence.

## Screens & States
- Screen: Inbox
  - Loading: Skeleton grid/list
  - Empty: "No receipts in Inbox" with hint how to add
  - Error: Fetch error with Retry
  - Validation: Drag targets constrained to valid trips/days; undo within 10 s
- Screen: Duplicates
  - Loading: Pair previews
  - Empty: "No suspected duplicates"
  - Error: If confirm/dismiss fails â†’ inline error; retry

## Navigation
- Inbox â†” Duplicates section
- Receipt card â†’ opens receipt detail (optional); back returns to context

## Components & Tokens
- Components: ReceiptCard, Badge (confidence/duplicate), DragTargets, Checkbox, BatchBar, Toast
- Tokens: State colors; spacing grid; typography per E-002

## Accessibility & Responsiveness
- A11y: Keyboard drag alternatives (assign via menu); ARIA drop targets; tooltips accessible
- Breakpoints: Grid â†’ list; ensure tap targets â‰¥ 44 px

## Telemetry (optional)
- Events: inbox_assign_drag, inbox_batch_assign(count), duplicate_confirmed, duplicate_dismissed, confidence_tooltip_opened


---

# E-006 Review & Submission

## Intent
Allow users to review, correct, and submit expenses with perâ€‘diems and FX clarity.

## In-Scope
- Crossâ€‘trip receipt move with recompute and audit
- Trip list: status, simple filters, quickâ€‘fix chips
- Travel times editor
- Perâ€‘diem breakdown with meal reductions toggles
- Mileage entry & calculation (perâ€‘km) with policy rate lookup and audit
- Reimbursement summary with ECB FX rate/date labels
- Trip readiness checklist with quickâ€‘fix actions

## Out-of-Scope (optional)
- Baseline Plan vs Actual (hidden in MVP)

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 Crossâ€‘Trip Move
- R-002 Perâ€‘Diem Breakdown & Meal Reductions
- R-003 Reimbursement Summary (ECB FX)
- R-004 Travel Times Editor
- R-005 Trip Readiness Checklist
- R-006 Trip List with Status & Missing Items
- R-007 Chat Q&A, Readiness & Submit
- R-008 Mileage Entry & Calculation


### Requirements

# R-001 Crossâ€‘Trip Move

## Why
Maintain accurate grouping of receipts while preserving data integrity and providing clear audit trails for compliance.

## Behavior
- **Receipt Movement**: Move receipts across trips with immediate recomputation of totals
- **Data Validation**: Prevent moves that would create invalid business scenarios
- **Audit Trail**: Maintain complete audit trail of all moves with user attribution
- **Business Rules**: Enforce business logic to prevent inappropriate moves
- **User Confirmation**: Require explicit confirmation for significant moves

## Business Rules
- **Move Validation**: Prevent move if submission is locked or approved
- **Data Recalculation**: Automatically recalculate trip totals, per-diems, and reimbursements
- **Audit Requirements**: Log all moves with before/after values and business justification
- **Permission Check**: Verify user has permission to move receipts between trips
- **Business Logic**: Prevent moves that violate company policy or compliance rules

## Scenarios (BDD)
Scenario: Successful cross-trip receipt move
Given a receipt assigned to Trip A
When the user moves it to Trip B
Then Trip A totals decrease and Trip B totals increase accordingly
And all calculations (per-diems, reimbursements) are updated
And the move is logged in the audit trail with user attribution

Scenario: Move prevented due to locked submission
Given a receipt is assigned to Trip A
When Trip A is locked for submission
Then the move operation is blocked
And a clear message explains why the move cannot proceed
And guidance is provided on when moves will be allowed again

Scenario: Move with business rule validation
Given a user attempts to move a receipt to Trip B
When the move would violate business policy
Then the operation is prevented
And the specific policy violation is explained
And alternative solutions are suggested

Scenario: Bulk move of multiple receipts
Given multiple receipts are selected in Trip A
When the user moves them to Trip B
Then all receipts are moved in a single operation
And totals are recalculated for both trips
And a summary of the bulk move is displayed
And individual audit entries are created for each receipt

Scenario: Move with approval workflow impact
Given a receipt is moved from Trip A to Trip B
When Trip A was previously approved
Then the approval status is updated accordingly
And stakeholders are notified of the change
And the approval workflow is adjusted if needed


# R-002 Perâ€‘Diem Breakdown & Meal Reductions

## Why
Provide transparent perâ€‘diem calculation with policy defaults.

## Behavior
- Show perâ€‘day perâ€‘diem with country detection and rate source label (country/city, effective date)
- Meal toggles (breakfast/lunch/dinner) affecting amounts per policy; support batch apply across selected days
- Track overrides with audit note; provide "Explain" tooltip with calculation details

## Scenarios (BDD)
Scenario: Meal toggle reduces perâ€‘diem
Given lunch is toggled as provided
When the perâ€‘diem recalculates
Then the day's amount decreases per policy rules


# R-003 Reimbursement Summary (ECB FX)

## Why
Ensure accurate multiâ€‘currency totals with transparent rates.

## Behavior
- Use ECB daily FX rate at receipt transaction date by default
- Display FX rate and date per receipt and in summary
- Allow admin override source later (not in MVP UI)

## Scenarios (BDD)
Scenario: Display ECB rate used
Given a receipt in USD dated 2025â€‘05â€‘10
When viewing the summary
Then the applied ECB rate and date 2025â€‘05â€‘10 are displayed


# R-004 Travel Times Editor

## Why
Allow correction of travel segments affecting perâ€‘diems.

## Behavior
- Edit start/end times per travel day
- Validate overlaps and gaps
- Recompute perâ€‘diems when any edited segment changes the day-tier thresholds (e.g., <8h â†’ â‰¥8h, â‰¥24h), overnight transitions, or country boundary crossings.

## Scenarios (BDD)
Scenario: Adjust travel end time
Given a travel day ending at 18:00
When the user changes it to 20:00
Then the perâ€‘diem is recomputed if the edit crosses a policy threshold or boundary


# R-005 Trip Readiness Checklist

## Why
Surface missing information early.

## Behavior
- Inline checklist for missing destination, dates, purpose
- Quickâ€‘fix actions to resolve missing items
- Ready status shown in Review

## Scenarios (BDD)
Scenario: Resolve missing destination
Given a trip missing destination
When the user sets the destination via quickâ€‘fix
Then the checklist item is marked complete


# R-006 Trip List with Status & Missing Items

## Why
Provide a clear entry point to review progress and outstanding tasks without overwhelming the user.

## Behavior
- Show a list of trips with compact cards: title, dates, readiness chip, total amount.
- Display missing items per trip (e.g., destination, dates, purpose, receipts) as a concise inline hint.
- Quick chips per card: What's missing, Open, Submit (disabled until Ready). Submit chip becomes enabled when Ready.
- Search by text (trip name, destination) and simple filters: Ready, In Progress, Draft. Advanced filters live under "More".
- Clicking What's missing opens the checklist in context (same Review surface) and focuses the first blocker.
- Deep links to a specific trip land on Review detail.

## Scenarios (BDD)
Scenario: Trip shows missing purpose
Given a trip without a purpose
When viewing the Review trip list
Then the trip displays a Missing Purpose indicator
And a quick-link navigates to add the purpose

Scenario: Submit chip is disabled until Ready
Given a trip that is not Ready
When viewing its card on the list
Then the Submit chip is disabled
And when the trip becomes Ready
Then the Submit chip becomes enabled

Scenario: Filter trips by Ready status
Given multiple trips with different statuses
When the user applies the Ready filter
Then only Ready trips appear in the list

## Accessibility & Responsiveness
- Cards are fully keyboard operable; chip hit areas â‰¥ 44 px; list supports screen-reader friendly headings.

## Telemetry (optional)
- Events: review_trip_search_used, review_trip_filter_used, review_trip_submit_chip_clicked, review_trip_missing_clicked


# R-007 Chat Q&A, Readiness & Submit

## Why
Allow users to understand and finalize trips without leaving chat.

## Behavior
- Q&A: support questions on totals, policy flags, missing items, perâ€‘diem changes, and duplicate receipts. Responses must include inline quickâ€‘fix actions and reference the affected entity IDs.
- Readiness: â€œWhatâ€™s missing?â€ returns a checklist; users can tap actions (set destination/date/purpose) in-thread.
- Submission: â€œSubmit tripâ€ asks for confirmation and posts the submission result with policy score/context.
- Errors: actionable messages with reference codes and safe retry.

## Scenarios (BDD)
Scenario: Resolve missing items and submit in chat
Given a trip with missing destination
When the user asks "Whatâ€™s missing?"
Then the assistant shows a checklist with a Set Destination action including the trip ID and a deep link
When the user sets the destination and says "Submit trip"
Then the assistant asks for confirmation
And upon Yes, the trip is submitted and a confirmation is posted


# R-008 Mileage Entry & Calculation

## Why
Provide a simple, auditable way to reimburse private car trips using policy perâ€‘km rates.

## Behavior
- Create a mileage expense with fields: date, origin (optional), destination (optional), distance in kilometers, vehicle class (optional per policy).
- Auto-detect country/policy rate from trip context and date; compute amount = kilometers Ã— effective perâ€‘km rate.
- Show rate label and source (country, vehicle class, effective date). Link to policy info (read-only in MVP).
- Allow manual override of rate with required audit note.
- Support edit/delete with undo for 10 minutes.
- Suggest remembered routes (e.g., Home â†” Client HQ); flag outlier distances and require confirm.
- Chat intents: â€œAdd 42 km to Trip Berlin on Jan 16â€ and â€œChange yesterdayâ€™s mileage to 38 kmâ€; confirmation before apply.

## Scenarios (BDD)
Scenario: Create mileage with auto rate
Given a trip in Germany on 2025â€‘01â€‘16
And the user adds mileage of 42 km
When the system computes reimbursement
Then the perâ€‘km rate effective on 2025â€‘01â€‘16 for Germany is applied
And the amount is shown with the rate label

Scenario: Override rate with audit note
Given a mileage entry exists
When the user overrides the rate
Then a required note is captured and linked in audit

Scenario: Chat creates mileage
Given the user is in Chat
When the user says "Add 42 km to Berlin trip on Jan 16"
Then the system disambiguates if needed and creates a mileage expense
And posts a confirmation with undo




### Userflows

# UF-006 Conversational Review, Readiness & Submit (Chat)

## Scope
- Epic: `E-006-review-and-submission`
- Goal: Let users understand status, fix missing items, and submit a trip entirely within chat.
- Entry: User opens Chat and types a question (e.g., "Whatâ€™s missing for the Berlin trip?") or "Submit the Berlin trip".
- Exit: Missing items resolved and trip submitted; audit link posted in chat.

## Personas & Context
- Traveler; Manager (read-only explanations via chat).

## Flow (numbered)
1) User asks "Whatâ€™s missing for Trip Berlin?"
   - System: Returns a readiness checklist (destination/date/purpose/receipts) with quick-fix chips.
2) User taps "Set destination" â†’ picks Berlin
   - System: Applies change; re-checks readiness; updates checklist.
3) User asks about totals/policy
   - System: Replies with totals and policy flags; offers "Explain" links.
4) User says "Submit trip"
   - System: Validates readiness; if missing items remain, shows blockers; else asks for confirmation.
5) User confirms "Yes"
   - System: Submits trip; posts confirmation with policy score and a link to the flow task; offers Undo window if supported.
6) Errors (validation/API)
   - System: Post inline error with reference code; provide safe retry.

## Screens & States
- Screen: Chat Home (Review context)
  - Loading: Skeleton bubbles
  - Empty: Suggest prompts for review (Readiness, Totals, Submit)
  - Error: Inline error bubble with retry
  - Validation: Confirmation required before submission

## Navigation
- Chat (Review context) â†’ Trip Detail (optional) via "Open Trip" chip

## Components & Tokens
- Components: LLMChatBubble, Checklist, InlineActionChips, SubmitBar (inline), PolicyBadge
- Tokens: E-002 tokens; high-contrast for warn/block; 8pt spacing; Roboto

## Accessibility & Responsiveness
- A11y: aria-live for checklist updates; chips keyboard operable; confirmations focus management
- Breakpoints: Mobile bottom sheet for pickers; desktop side panel context

## Telemetry (optional)
- Events: chat_readiness_requested, chat_quickfix_applied(field), chat_submit_requested, chat_submit_confirmed, chat_submit_blocked(reason)


# UF-006 Review, Fix & Submit

## Scope
- Epic: `E-006-review-and-submission`
- Goal: Make a trip Ready and submit with clarity on perâ€‘diems and FX.
- Entry: User opens Review section or deep link to a trip.
- Exit: Trip submitted (or Ready with issues resolved).

## Personas & Context
- Traveler; Manager preview via toggle (read-only).

## Flow (numbered)
1) Trip list shows status and missing items
   - System: Each trip shows indicators (e.g., Missing purpose, receipts).
2) User opens Trip A â†’ Review workspace
   - System: Shows per-day timeline, receipts list (with Move actions on cards), perâ€‘diem panel, and Mileage card.
3) Crossâ€‘trip move
   - User uses Move on a receipt card or menu; System recomputes totals/perâ€‘diems; audit logs move; Undo 10 minutes.
4) Meal reductions
   - User toggles lunch provided; System recalculates perâ€‘diem; adds audit note.
5) Mileage entry
   - User adds 42 km; System autoâ€‘applies perâ€‘km rate by date/country; shows computed amount with rate label.
6) Travel times editor
   - User adjusts end time; System validates overlaps/gaps; recomputes if needed.
7) Reimbursement summary
   - System displays totals with ECB FX rate/date per receipt and in summary.
8) Readiness checklist
   - User fixes missing destination via quickâ€‘fix; Ready badge turns green when all complete.
9) Submit
   - User clicks Submit; System blocks if not Ready; else submits and shows confirmation.

## Screens & States
- Screen: Review â€“ Trip List
  - Loading: Skeleton list
  - Empty: "No trips yet"
  - Error: Fetch error + Retry
- Screen: Review â€“ Trip Detail
  - Loading: Panels lazy-load; skeletons under 100 ms
  - Empty: Perâ€‘receipt or perâ€‘day panels can show empty state hints
  - Error: Inline errors with reference codes; safe retry per action
  - Validation: Prevent move if submission locked

## Navigation
- Trip list â†’ Trip detail â†’ Receipt detail (optional)
- Manager View toggle â†’ read-only preview of approval sheet

## Components & Tokens
- Components: Checklist, Timeline, ReceiptList, PerDiemPanel, MileageCard, SummaryFX, Toggle, TimeEditor, SubmitBar
- Tokens: E-002 tokens; consistent spacing/typography; status colors

## Accessibility & Responsiveness
- A11y: Announce recalculations; focus management after quick-fix; tables have headers; keyboard operable controls
- Breakpoints: Mobile-first stacked panels; desktop split view

## Telemetry (optional)
- Events: review_cross_trip_move, per_diem_toggle(meal), travel_time_changed, fx_rate_viewed, readiness_complete, submit_clicked, submit_blocked(reason)


---

# E-007 Approvals

## Intent
Provide a clear manager approval flow with preview for travelers and delegation support.

## In-Scope
- Final-only (single-step) approval model
- Default approver assignment = employeeâ€™s line manager from the directory (overrideable by IT Administrator)
- Manager view toggle for traveler preview
- Manager approval sheet: Approve/Reject (+ comment on reject)
- Delegation on inactivity

## Out-of-Scope (optional)
- Multi-step approval chains (beyond final-only)
- Vendor approvals (disabled; routed via flow engine)

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 Manager View Toggle
- R-002 Approval Sheet (Approve/Reject + Comment)
- R-003 Delegation on Inactivity
- R-004 Final-Only Approval Model


### Requirements

# R-001 Manager View Toggle

## Why
Allow travelers to preview approval rendering.

## Behavior
- Toggle in UI to switch to manager view
- Readâ€‘only preview; no state changes
- Return to traveler view persists state

## Scenarios (BDD)
Scenario: Toggle to manager view
Given a traveler is reviewing a report
When they toggle Manager View
Then the approval sheet preview is shown


# R-002 Approval Sheet (Approve/Reject + Comment)

## Why
Enable decisive approvals with clear context while keeping the UI simple.

## Behavior
- Primary action: Approve (optional note field)
- Secondary action: Reject (required comment textarea)
- Tertiary actions: Delegate, Remind me later, Open in Chat, Download PDF summary
- Decision gating: Allow Approve when warnings (yellow) exist â†’ require confirm; Block Approve when blockers (red) exist
- Idempotency: Multiple attempts resolve to a single decision; subsequent attempts show "Already decided"
- Receipts preview: lightweight modal from the list; close returns to sheet
- Activity & comments: show decision history and inline comments; reject comment required; approve note optional
- Audit: record approver, timestamp, decision, note/comment, and submission hash

## Scenarios (BDD)
Scenario: Reject requires comment
Given a manager opens an approval task
When they click Reject
Then they must enter a comment to proceed

Scenario: Approve with warnings requires confirm
Given a task with policy warnings but no blockers
When the manager clicks Approve
Then a confirmation is required before applying the decision

Scenario: Approve blocked on blockers
Given a task with policy blockers
When the manager clicks Approve
Then the action is blocked and the blockers are highlighted

Scenario: Idempotent decision
Given an approval was already decided
When another decision is attempted
Then the system shows "Already decided" and no new audit entry is created

## Accessibility & Performance
- Keyboard operable actions; labels on fields; announce decision results via aria-live
- Initial load uses skeletons; receipt previews lazy-load

## Telemetry (optional)
- Events: approval_opened, approve_clicked, reject_clicked, reject_comment_added, decision_confirmed, decision_blocked, decision_conflict, open_in_chat_clicked, pdf_download_clicked

## Access Control
- Only users with Manager role and who are the assigned approver can act on the approval sheet; others see read-only.

## Scenarios (BDD) â€” access
Scenario: Non-manager cannot approve
Given a signed-in user without the Manager role
When they open an approval sheet via deep link
Then actions Approve/Reject are not shown
And a message indicates insufficient permissions


# R-003 Delegation on Inactivity

## Why
Prevent stuck approvals.

## Behavior
- Delegate task if the manager remains inactive beyond a configurable SLA threshold (business days)
- SLA days are configured in Settings (see `E-012 Admin & Configuration / R-004 Approvals SLA Settings`), default 5, range 1â€“30
- Notify both original approver and delegate on delegation; include deep links
- Keep audit of delegation (who, when, from â†’ to)

## Scenarios (BDD)
Scenario: Autoâ€‘delegate after inactivity
Given a manager has not acted for the configured SLA duration
When the threshold is reached
Then the task is delegated to the configured delegate
And both parties are notified
And an audit entry records the delegation


# R-004 Final-Only Approval Model

## Why
Keep the approval process simple and fast for MVP while maintaining compliance and audit requirements through a single, final approver model.

## Behavior
- **Single Approver**: Each submission has exactly one approver responsible for the final decision
- **Immediate State Change**: Approval decision immediately changes submission state to Final Approved/Rejected
- **No Intermediate Steps**: No intermediate approval steps are configured in MVP
- **Complete Audit Trail**: Record approver, timestamp, decision, and any comments
- **Business Rule Enforcement**: Apply business rules and policy validation before allowing approval

## Business Rules
 - **Approver Assignment**: Each submission must have exactly one assigned approver (default = employeeâ€™s line manager from the directory; overrideable by IT Administrator)
- **Decision Finality**: Once approved/rejected, the decision cannot be changed
- **Comment Requirement**: Rejections require mandatory comment explaining the reason
- **Policy Validation**: Approvals blocked if business rules or policy violations exist
- **Audit Requirements**: Complete audit trail with user attribution and timestamp

## Scenarios (BDD)
Scenario: Final approver approves submission
Given a submission awaiting approval
And exactly one approver is assigned
When the approver clicks Approve
Then the submission state becomes Final Approved
And the audit trail records the approver and timestamp
And the submission is moved to the approved queue
And stakeholders are notified of the approval

Scenario: Final approver rejects with required comment
Given a submission awaiting approval
And exactly one approver is assigned
When the approver clicks Reject and enters a comment
Then the submission state becomes Final Rejected
And the comment is stored in the audit trail
And the rejection reason is communicated to the submitter
And the submission is returned for correction

Scenario: System prevents adding additional approval steps
Given system configuration for approvals
When an admin attempts to add a second approval step
Then the system rejects the change in MVP with an explanatory message
And the current single-approver model is maintained
And guidance is provided on post-MVP multi-step capabilities

Scenario: Approval blocked due to policy violations
Given a submission has policy violations
When the approver attempts to approve
Then the approval is blocked
And specific policy violations are clearly displayed
And guidance is provided on how to resolve the issues
And the submission remains in pending status

Scenario: Approver delegation handling
Given the assigned approver is unavailable
When the delegation period expires
Then the system automatically delegates to the backup approver
And the original approver is notified of the delegation
And the audit trail records the delegation action
And the submission timeline is adjusted accordingly


# R-005 In-Chat Final Approval

## Why
Speed up approvals by letting approvers act directly in chat while preserving auditability.

## Behavior
- Approvers receive approval cards/messages in chat with Approve/Reject actions and required comment on reject.
- Role/permission checks ensure only the assigned approver sees actions.
- Decision updates the item state immediately and posts a confirmation with audit details.
- Optional: "Why over limit?" explanation link shows LLM rationale using policy context.

## Scenarios (BDD)
Scenario: Approve in chat
Given an approval awaiting the final approver
When the approver clicks Approve in chat
Then the item state changes to Final Approved
And the audit trail records the approver, timestamp, and decision

Scenario: Reject in chat with note
Given an approval awaiting the final approver
When the approver clicks Reject and enters a note
Then the item state changes to Final Rejected
And the note is recorded in the audit trail


### Userflows

# UF-007 Approvals (Final-Only)

> Note: The in-chat approval flow is primary for MVP. This sheet-based flow remains available as an optional detail view.

## Scope
- Epic: `E-007-approvals`
- Goal: One-tap final approvals with preview and safe delegation.
- Entry: Manager opens Approvals tab or deep link to a task.
- Exit: Task approved/rejected; delegation if inactive.

## Personas & Context
- Manager; Traveler uses Manager View toggle (read-only preview).
- Default approver is the employeeâ€™s line manager from the directory (overrideable by IT Administrator).

## Flow (numbered)
1) Manager opens Approvals tab
   - System: Shows condensed cards; newest first.
2) Manager taps a task â†’ Approval Sheet
   - System: Shows summary, totals, policy status; Approve/Reject actions.
3) Reject path
   - Manager taps Reject; System requires comment; on submit, decision recorded with timestamp/actor.
4) Approve path
   - Manager taps Approve; System records decision; state changes to Final Approved; triggers downstream.
5) Delegation on inactivity
   - If no action for threshold (e.g., 3 days), System delegates; notifies both; audit entry.
6) Traveler preview
   - Traveler toggles Manager View; System shows read-only Approval Sheet.
7) Deep link guard
   - If active role is Traveler and user opens `/approvals/:id`, System shows 403 card with CTA "Switch to Manager"; on confirm, switches role and opens the approval.

## Screens & States
- Screen: Approvals List
  - Loading: Skeleton cards
  - Empty: "No approvals pending"
  - Error: Fetch error; Retry
- Screen: Approval Sheet
  - Loading: Inline skeleton for totals
  - Empty: n/a
  - Error: Decision failed; inline error; retry
  - Validation: Reject requires comment; buttons disabled during submit

## Navigation
- Approvals list â†’ Approval Sheet â†’ back maintains scroll position
- Traveler Review â†’ Manager View toggle â†’ back to traveler view

## Components & Tokens
- Components: ApprovalCard, ApprovalSheet, CommentInput, Button, Toast, Badge
- Tokens: E-002 tokens; clear affordances for Approve (primary) and Reject (ghost/danger)

## Accessibility & Responsiveness
- A11y: Buttons labeled; comment input with aria-required; focus returns to previous element
- Breakpoints: Mobile-first sheet; desktop side panel

## Telemetry (optional)
- Events: approvals_opened, approval_opened, approval_decision(type), approval_reject_no_comment_blocked, delegation_triggered


# UF-007 In-Chat Final Approval

## Scope
- Epic: `E-007-approvals`
- Goal: Allow approvers to approve/reject directly in chat with auditability.
- Entry: Approver opens Chat or receives a chat notification for a pending approval.
- Exit: Item approved/rejected with audit confirmation.

## Personas & Context
- Manager (approver); Traveler can view read-only in chat.

## Flow (numbered)
1) System posts an approval card in chat (Title, amount, policy status) with Approve/Reject actions
   - System: Only visible/actionable to the assigned approver; others see read-only.
2) Approver taps Approve
   - System: Records decision; updates item to Final Approved; posts confirmation with approver, timestamp, audit link.
3) Approver taps Reject
   - System: Prompts for required comment; on submit, records Final Rejected; posts confirmation.
4) Delegation on inactivity
   - System: If no action within threshold, posts delegation notice; new approver receives card; audit updated.
5) Errors
   - System: Shows inline error with retry; prevents double-submit; idempotent on retries.

## Screens & States
- Screen: Chat Home (Approvals context)
  - Loading: Skeleton card placeholder
  - Empty: "No approvals pending"
  - Error: Decision failed; inline error; retry action
  - Validation: Reject requires comment; actions disabled during submit

## Navigation
- Chat approval card â†’ Approval Sheet (optional) for full details

## Components & Tokens
- Components: ApprovalCard (chat), Button, CommentInput, Badge, Toast
- Tokens: E-002 tokens; clear affordances for Approve (primary) and Reject (danger)

## Accessibility & Responsiveness
- A11y: Buttons labeled; comment input aria-required; announce decision results via aria-live
- Breakpoints: Mobile-first card; desktop side panel for details

## Telemetry (optional)
- Events: chat_approval_card_shown, chat_approval_approve, chat_approval_reject, chat_approval_error, chat_delegation_triggered


# UF-007 Wireframes â€” Approvals (Final-Only + In-Chat)

## Scope
- Epic: `E-007-approvals`
- Goal: Show Approvals list, Approval Sheet, and in-chat approval card.

## Mobile â€” Approvals List
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Approvals (Manager) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Card] Trip Milan â€” â‚¬243.20  [Warnings â€¢]        â”‚
â”‚        Alice â€¢ Due: Today                        â”‚
â”‚ [Card] Trip Berlin â€” â‚¬118.50                     â”‚
â”‚        Bob â€¢ Due: Tomorrow                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Cards show submitter, amount, due, policy status
- Traveler sees read-only preview via Manager View toggle

## Mobile â€” Approval Sheet
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Approval â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Totals    Policy Status (warnings)  â”‚
â”‚ Receipts (preview)                  â”‚
â”‚ Comments & Activity                 â”‚
â”‚                                      â”‚
â”‚ [Reject (requires comment)] [Approve]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Reject opens comment modal; Approve confirms if warnings
- Accessibility: buttons labeled; aria-required on comment

## Desktop â€” Approval Sheet (Side Panel)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ List â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Card list            â”‚ Header: submitter/amount       â”‚
â”‚ â€¦                    â”‚ Tabs: Summary â€¢ Receipts â€¢ Log â”‚
â”‚                      â”‚ Footer: Reject â€¢ Approve       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Back preserves scroll position

## In-Chat Approval Card (for assigned approver)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Approval â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Milan â‚¬243.20 â€” Warnings: 1             â”‚
â”‚ [Reject]   [Approve]                     â”‚
â”‚ "Reject requires comment"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Others see read-only; actions hidden

## Guards & Defaults
- Default approver = employeeâ€™s line manager (overrideable by IT Administrator)
- Deep link guard: 403 with "Switch to Manager" CTA when needed

## States
- Loading: Skeleton cards; inline skeleton in sheet
- Empty: "No approvals pending"
- Error: Decision failed â†’ inline error + Retry

## Components
- ApprovalCard (list & chat), ApprovalSheet, CommentModal, Toast, Badge

## Accessibility
- Focus returns to previous element after decision; aria-live announces results

## Telemetry
- approvals_opened, approval_opened, approval_decision(type), approval_reject_no_comment_blocked, delegation_triggered


---

# E-008 Policy & Perâ€‘Diems

## Intent
Implement a versioned perâ€‘diem engine and policy scoring with explainability.

## In-Scope
- Versioned EU perâ€‘diem engine with proration and meal reductions
- PolicyScore + explain tooltips
- Readyâ€‘fields validator

## Out-of-Scope (optional)
- Admin editing UI (separate in Admin)

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 Versioned EU Perâ€‘Diem Engine
- R-002 PolicyScore with Explain Tooltips
- R-003 Readyâ€‘Fields Validator


### Requirements

# R-001 Versioned EU Perâ€‘Diem Engine

## Why
Ensure accurate, auditable EU perâ€‘diems over time with EUR base currency and ECB FX rates.

## Behavior
- **MVP Scope**: EU per-diems only (no other jurisdictions in MVP)
- **Base Currency**: EUR (Euro) as primary currency
- **FX Source**: ECB daily rates; store rate + timestamp (as-of date)
- **Effective-dated Tables**: Per country/city with versioning
- **Calculation Rules**: Per-day proration by local destination midnight
- **Rounding**: Round half-up to 2 decimal places
- **Version History**: Complete audit trail with rollback capability

## Technical Requirements
- **EU Coverage**: All EU member states with city-specific rates
- **Effective Dating**: Rate changes with clear effective dates
- **Proration Logic**: Per-day calculation by local midnight
- **Meal Reductions**: Matrix-based meal reduction factors
- **FX Integration**: ECB rate lookup and storage
- **Audit System**: Complete change history with user attribution

## Scenarios (BDD)
Scenario: EU per-diem rate calculation
Given a trip to Berlin on 2025â€‘01â€‘15
When computing perâ€‘diem
Then the EU rate effective on 2025â€‘01â€‘15 is used
And the amount is calculated in EUR with ECB FX rates

Scenario: Effective-dated rate change
Given a per-diem rate change for Paris effective 2025-02-01
When computing per-diem for a trip spanning January-February
Then different rates apply for different periods
And the change is audited with effective date tracking

Scenario: EUR base currency with ECB FX
Given a receipt in USD from a trip to Rome
When calculating reimbursement
Then the amount is converted to EUR using ECB rates
And the FX rate and date are stored for audit purposes


# R-002 PolicyScore with Explain Tooltips

## Why
Provide transparent policy evaluation with explainable tooltips for users and administrators.

## Behavior
- **PolicyScore Calculation**: Compute score per receipt/trip based on policy compliance
- **Explain Tooltips**: Tooltips explain contributing rules, weights, and decisions
- **Admin Integration**: Link to policy definition in admin interface
- **Guided Setup**: Policy configuration through guided admin wizard
- **Audit Trail**: Complete tracking of policy decisions and scoring

## Technical Requirements
- **Scoring Algorithm**: Transparent policy evaluation with clear weights
- **Tooltip System**: Interactive tooltips showing policy details
- **Admin Interface**: Integration with policy configuration UI
- **Policy Linking**: Direct links from tooltips to policy definitions
- **Real-time Updates**: Policy changes immediately reflected in scoring
- **Audit System**: Complete history of policy decisions and changes

## Scenarios (BDD)
Scenario: Tooltip explains low PolicyScore
Given a receipt violates a meal limit policy
When hovering over the PolicyScore
Then a tooltip lists the violated rule and weight
And provides a link to the policy definition

Scenario: Admin configures policy through guided interface
Given a Finance Administrator wants to adjust policy weights
When they use the guided policy configuration wizard
Then policy changes are applied with validation
And PolicyScore calculations immediately reflect the new rules

Scenario: PolicyScore audit trail
Given a policy change affects multiple receipts
When the PolicyScore is recalculated
Then the change history is tracked with user attribution
And users can see when and why scores changed


# R-003 Readyâ€‘Fields Validator

## Why
Ensure required fields are complete before submission with configurable validation rules.

## Behavior
- **Configurable Validation**: Required fields defined per policy through admin interface
- **Real-time Validation**: Show inline errors and how to fix during data entry
- **Submission Control**: Block submission until all required fields are Ready
- **Admin Configuration**: Finance Administrators can configure validation rules
- **Guided Setup**: Validation rules configured through guided admin wizard

## Technical Requirements
- **Dynamic Validation**: Policy-based field requirements configurable by admins
- **Real-time Feedback**: Immediate validation feedback with clear error messages
- **Admin Interface**: Integration with policy configuration UI
- **Validation Engine**: Flexible rule engine for different field types
- **Error Handling**: Clear guidance on how to resolve validation issues
- **Audit Trail**: Track validation rule changes and their impact

## Scenarios (BDD)
Scenario: Missing purpose blocks submission
Given a required field Purpose is empty
When attempting to submit
Then submission is blocked with a clear error message
And guidance is provided on how to fix the issue

Scenario: Admin configures validation rules
Given a Finance Administrator wants to add new required fields
When they use the guided validation configuration wizard
Then validation rules are applied with real-time testing
And all existing submissions are re-evaluated against new rules

Scenario: Dynamic validation updates
Given a validation rule is changed in the admin interface
When the change is applied
Then all active forms immediately reflect the new validation
And users receive updated guidance on required fields


# R-004 COâ‚‚ Tradeâ€‘Off UI

## Why
Expose environmental impact alongside policy and cost.

## Behavior
- Display perâ€‘receipt COâ‚‚ scope indicator
- Show tradeâ€‘off tooltip between cost and COâ‚‚ where applicable
- Persist COâ‚‚ data for export

## Scenarios (BDD)
Scenario: COâ‚‚ indicator shown on receipt
Given a receipt eligible for COâ‚‚ scope
When viewing the receipt
Then a COâ‚‚ indicator is displayed with tooltip


### Userflows

# UF-008 Conversational Policy Explain & Quick-Fix (Chat)

## Scope
- Epic: `E-008-policy-per-diem`
- Goal: Let users ask "Why over limit?" and apply guided fixes directly in chat.
- Entry: User is in Chat and asks about a policy issue (e.g., "Why is this hotel over limit?"), or taps an Explain link.
- Exit: User understands the policy outcome; optional fix applied; policy score recalculated.

## Personas & Context
- Traveler (asks/explains/fixes); Manager (reads explanations); Finance (reads, may enforce).

## Flow (numbered)
1) Trigger: User asks "Why over limit?" in chat (receipt or trip context)
   - System: Detects context (receipt/trip); fetches policy evaluation; posts an explanation message.
2) Explanation message
   - System: Lists contributing rules with weights and outcomes (e.g., Max hotel â‚¬/night = 120; observed = 135; delta = +15).
   - System: Provides Quick-Fix chips if actionable (e.g., "Mark breakfast provided", "Change category", "Request exception").
3) User selects a Quick-Fix (e.g., Mark breakfast provided)
   - System: Applies change; recalculates perâ€‘diem/policy score; posts updated score and effect summary; offers Undo.
4) Exception path
   - User taps "Request exception"
   - System: Asks for short justification; creates exception request; links to approval task; posts confirmation.
5) No-action path
   - User acknowledges explanation without changes; message remains in the thread for audit context.
6) Errors
   - System: Posts inline error with reference code; allows retry; no partial updates without confirmation.

## Screens & States
- Screen: Chat Home (Policy context)
  - Loading: Skeleton bubble for explanation while fetching
  - Empty: Suggest prompt: "Why over limit?", "Explain perâ€‘diem for Day 2"
  - Error: Inline error bubble with retry
  - Validation: Confirmation for exception requests; Undo for applied quick fixes
- Screen: Policy Explain Panel (optional)
  - Loading: Rules list skeleton
  - Empty: n/a
  - Error: Fallback to a compact summary if details fail

## Navigation
- Chat â†’ Policy Explain Panel (optional) â†’ back returns to chat position
- Chat â†’ Trip/Receipt detail via "Open" chip when deeper context needed

## Components & Tokens
- Components: LLMChatBubble, PolicyScoreChip, Tooltip/Panel, QuickFixChips, Button
- Tokens: E-002 tokens; warn/block semantic colors; focus ring

## Accessibility & Responsiveness
- A11y: Explanation content structured with headings/lists; quick-fix chips are buttons with labels; aria-live on score updates
- Breakpoints: Panel becomes bottom sheet on mobile; side panel on desktop

## Telemetry (optional)
- Events: chat_policy_explain_requested, chat_policy_quickfix_applied(type), chat_exception_requested, chat_policy_explain_error


# UF-008 Policy Explain & Ready Validator

## Scope
- Epic: `E-008-policy-per-diem`
- Goal: Make policy evaluation transparent and block submissions until required fields are complete.
- Entry: User reviewing a trip or receipt detail.
- Exit: User understands policy impact; missing fields resolved; submission unblocked.

## Personas & Context
- Traveler; Manager (read-only explain); Finance (read-only).

## Flow (numbered)
1) User opens receipt in Review
   - System: Shows PolicyScore chip (e.g., 0.86) next to amount.
2) User taps PolicyScore chip
   - System: Opens explain tooltip: contributing rules with weights; links to policy.
3) User reads a violated rule (e.g., meal limit exceeded)
   - System: Provides "How to fix" hint if applicable.
4) User attempts to submit trip with missing Purpose
   - System: Ready-fields validator blocks; inline error at Purpose; Submit disabled; checklist highlights missing field.
5) User fills Purpose via quick-fix
   - System: Validator rechecks; errors clear; Submit enabled; Ready badge shown.

## Screens & States
- Screen: Receipt Detail (Policy Explain)
  - Loading: Tooltip content skeleton
  - Empty: n/a
  - Error: If loading policy fails â†’ fallback text; link to policy docs
  - Validation: Tooltip accessible; stays within viewport
- Screen: Trip Review (Ready Validator)
  - Loading: Checklist placeholder
  - Empty: All checks passed â†’ Ready
  - Error: Validation service error â†’ non-blocking banner; allow manual retry
  - Validation: Block submit until all required fields present

## Navigation
- Receipt detail â†” Review workspace
- Policy link opens policy definition (new tab or modal)

## Components & Tokens
- Components: PolicyScoreChip, Tooltip, Checklist, InlineError, SubmitBar
- Tokens: High-contrast for warn/block; spacing around tooltip; focus ring

## Accessibility & Responsiveness
- A11y: Tooltip opened via keyboard; ESC closes; aria-describedby ties chip to tooltip
- Breakpoints: Tooltip repositions on small screens; checklist stacks items

## Telemetry (optional)
- Events: policy_explain_opened, policy_rule_viewed(id), ready_validator_block(reason), ready_validator_resolved(field)


---

# E-009 Vendor Integration Layer

## Intent
Ingest events/webhooks from vendors and normalize into our domain with confidence and fallback rules.

## In-Scope
- Webhooks + polling ingest adapters
- Confidence schema for OCR/extraction
- Vendor OCR fallback wiring

## Out-of-Scope (optional)
- UI features

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 Vendor Ingest Adapter
- R-002 Confidence Schema
- R-003 OCR Fallback Integration


### Requirements

# R-001 Vendor Ingest Adapter

## Why
Normalize vendor events from TravelPerk, Rydoo, and Spendesk into our domain model reliably with a pragmatic integration approach.

## Behavior
- **Primary Vendors**: TravelPerk (travel), Rydoo (expenses), Spendesk (cards/spend)
- **Integration Approach**: Prefer near realâ€‘time ingestion with a resilient fallback path
- **Event Ingestion**: Accept vendor event deliveries and reconcile missed events via fallback
- **Event Schema**: Standardized across vendors with vendor-specific extensions
- **System of Record**: Per-diems, policy, approvals, settlement = OUR SYSTEM
- **Vendor Approvals**: DISABLED - route via our flow engine

## Scenarios (BDD)
Scenario: TravelPerk webhook ingested and normalized
Given TravelPerk sends a travel booking event
When the adapter processes it
Then a normalized travel event is published internally
And the event includes vendor-specific travel details

Scenario: Rydoo expense event with OCR fallback
Given Rydoo sends an expense receipt event
When our OCR fails to process the receipt
Then vendor OCR is used as fallback
And confidence scoring reflects fallback usage

Scenario: Delivery issue with resilient fallback
Given a vendor event delivery fails repeatedly
When the resilient fallback is used
Then missed events are reconciled within a reasonable timeframe
And processing continues reliably


# R-002 Confidence Schema

## Why
Capture OCR/extraction reliability uniformly across our OCR and vendor OCR fallback systems to provide transparency and enable informed decision-making.

## Behavior
- **OCR Strategy**: Our OCR primary, vendor OCR as fallback only
- **Confidence Scoring**: Display confidence levels with clear thresholds and explanations
- **Source Attribution**: Clearly distinguish between our OCR and vendor OCR results
- **Fallback Logic**: Automatic fallback when our OCR confidence falls below threshold
- **User Transparency**: Show confidence scores and source in user interface

## Business Rules
- **Confidence Thresholds**: High (90%+), Medium (80-89%), Low (70-79%), Insufficient (<70%)
- **Fallback Trigger**: Automatic fallback when our OCR confidence <70%
- **Source Marking**: All results must clearly indicate OCR source (internal vs vendor)
- **Confidence Display**: Show confidence scores in user interface with tooltips
- **Audit Requirements**: Track all OCR source changes and confidence scores

## Scenarios (BDD)
Scenario: High confidence from our OCR
Given our OCR processes a receipt with 85% confidence
When storing the extraction result
Then confidence fields and raw text are stored together
And source is marked as "internal_ocr"
And the confidence level is displayed as "Medium"
And users can see the confidence score in the interface

Scenario: Fallback to vendor OCR
Given our OCR confidence is below 70%
When processing a receipt
Then vendor OCR is automatically triggered
And confidence reflects fallback usage with source marking
And users are informed that vendor OCR was used
And the confidence score is clearly labeled as vendor-sourced

Scenario: Confidence comparison across vendors
Given receipts from different vendors
When comparing confidence scores
Then scores are normalized to the same scale
And source attribution is clearly visible
And users can understand which OCR system provided each result
And confidence levels are consistently displayed

Scenario: Low confidence handling
Given a receipt has 65% confidence from vendor OCR
When displaying the result to users
Then a clear warning about low confidence is shown
And users are advised to review the extraction carefully
And manual correction options are prominently displayed
And the low confidence is noted in the audit trail

Scenario: Confidence score explanation
Given a user sees a confidence score
When they hover over or click on the score
Then a detailed explanation of what the score means is displayed
And factors contributing to the score are explained
And guidance on how to interpret the result is provided


# R-003 OCR Fallback Integration

## Why
Ensure extraction resilience by falling back to vendor OCR when needed.

## Behavior
- Use our OCR as primary
- On failure/low confidence, route to vendor OCR
- Merge results with provenance

## Scenarios (BDD)
Scenario: Fallback to vendor OCR
Given our OCR returns low confidence
When fallback is triggered
Then vendor OCR is invoked and results are merged with provenance labels


### Userflows

---

# E-010 Flow Orchestration

## Intent
Provide a BPMNâ€‘based flow engine to coordinate crossâ€‘system processes with reliability.

## In-Scope
- BPMN orchestration across vendor webhooks
- Idempotency, retries, and state transitions
- Mapping vendor event types â†’ our states

## Out-of-Scope (optional)
- Human task UI (covered in Approvals/Review)

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 BPMN Orchestration
- R-002 Idempotency & Retries
- R-003 Vendor Event Mapping


### Requirements

# R-001 Lightweight Step Runner Orchestration

## Why
Coordinate crossâ€‘system flows with clarity using a simplified, lightweight approach for MVP.

## Behavior
- **MVP Scope**: Limited to 3 core flows (Captureâ†’OCRâ†’Inbox, Reviewâ†’Readinessâ†’Submit, Approvalsâ†’Settlement)
- **Orchestration Engine**: Simple step runner (no complex BPMN features in MVP)
- **Flow Definition**: Lightweight flow definitions with brief step notes
- **State Management**: Persist state transitions and history
- **Metrics**: Basic reliability signals and progress counters

## MVP Flow Definitions

### Flow 1: Capture â†’ OCR â†’ Inbox
- File upload â†’ OCR processing â†’ Receipt classification â†’ Inbox assignment
- Error handling: Retry OCR, fallback to vendor OCR, manual review

### Flow 2: Review â†’ Readiness â†’ Submit
- Trip review â†’ Policy validation â†’ Readiness checklist â†’ Submission
- Error handling: Missing items, policy violations, approval routing

### Flow 3: Approvals â†’ Settlement
- Approval decision â†’ Settlement trigger (CSV export generation + PDF payment summary preparation)
- Error handling: Rejection handling, delegation, export generation failures

## Scenarios (BDD)
Scenario: Capture flow executes successfully
Given a receipt is uploaded via chat
When the capture flow executes
Then OCR processing completes and receipt is assigned to inbox
And the transition history includes all steps

Scenario: Flow orchestration with retry logic
Given a step in the flow fails
When retry logic is triggered
Then the system makes repeated attempts with increasing delays
And failure is recorded for follow-up after retries are exhausted

Scenario: Event correlation with chat
Given a flow event is generated
When correlation between events and chat is available
Then the event is linked to the relevant conversation
And users can trace flow progress through the chat interface


# R-002 Idempotency & Retries

## Why
Prevent duplicates and ensure reliability with robust retry policies and clear escalation.

## Behavior
- **Idempotency**: Avoid processing the same vendor event more than once
- **Retry Logic**: Retries transient failures with increasing delays
- **Escalation**: After retries are exhausted, the event is flagged for manual follow-up
- **Reliability**: Processing is consistent and repeat-safe
- **Audit Trail**: Track retry attempts and final disposition

## Technical Requirements
- **Idempotency Keys**: Vendor event ID + timestamp deduplication
- **Exponential Backoff**: 1s, 2s, 4s retry intervals
- **Retry Limit**: Maximum 3 attempts before DLQ
- **DLQ Alerting**: Simple alert notification for failed events
- **Event Logging**: Append-only event log with retry history
- **Health Monitoring**: Basic counters for success, retry, and DLQ metrics

## Scenarios (BDD)
Scenario: Duplicate webhook ignored through idempotency
Given a webhook is delivered twice from the same vendor
When processing occurs
Then the second delivery is ignored due to idempotent handling
And the duplicate is logged for audit purposes

Scenario: Retry logic with backoff
Given a webhook processing fails
When retry logic is triggered
Then the system makes repeated attempts with increasing delays
And each retry attempt is logged with timestamp

Scenario: Event escalation after retries
Given a webhook fails after all retry attempts
When all retries are exhausted
Then the event is routed for manual review
And a notification is created for intervention

Scenario: Idempotency across vendor systems
Given events from multiple vendors
When processing occurs
Then each vendor's events are handled independently
And idempotency is maintained across all vendor integrations


# R-003 Vendor Event Mapping

## Why
Translate vendor-specific events from TravelPerk, Rydoo, and Spendesk into our canonical states with standardized event schema to ensure consistent business process handling.

## Behavior
- **Vendor Coverage**: TravelPerk (travel), Rydoo (expenses), Spendesk (cards/spend)
- **Event Normalization**: Standardize events across vendors while preserving vendor-specific details
- **Business Process Integration**: Map vendor events to our business workflows seamlessly
- **Data Consistency**: Ensure all vendor data is processed consistently regardless of source
- **Audit Trail**: Complete tracking of all vendor event processing and mapping decisions

## Business Rules
- **Event Validation**: All vendor events must pass validation before processing
- **Mapping Consistency**: Same vendor event type always maps to same canonical state
- **Data Preservation**: Vendor-specific details must be preserved in canonical events
- **Error Handling**: Failed mappings must be logged and reported for resolution
- **Performance Requirements**: Event mapping completed within business SLA timeframes

## Scenarios (BDD)
Scenario: TravelPerk travel event mapped to canonical state
Given TravelPerk sends a "booking_confirmed" event
When mapping is applied
Then our system records "travel_confirmed" state consistently
And the event includes TravelPerk-specific booking details
And the mapping is logged in the audit trail
And business processes are triggered accordingly

Scenario: Rydoo expense event with OCR results
Given Rydoo sends an "ocr_completed" event
When mapping is applied
Then our system records "receipt_processed" state
And OCR confidence and extracted data are preserved
And the receipt is queued for user review
And the mapping success is confirmed

Scenario: Cross-vendor event correlation
Given events from multiple vendors for the same trip
When correlation IDs are matched
Then all events are linked to the same business process
And the complete trip picture is assembled
And duplicate processing is prevented
And business rules are applied consistently

Scenario: Vendor mapping version management
Given a mapping table update is required
When the new mapping is deployed
Then all existing events continue to work
And new events use the updated mapping rules
And the mapping change is logged in the audit trail
And business processes adapt to the new mapping

Scenario: Failed event mapping handling
Given a vendor event cannot be mapped to canonical state
When the mapping fails
Then the event is logged as failed
And an alert is generated for manual review
And the vendor is notified of the mapping issue
And business processes continue with other events


# R-004 Intent â†’ Flow Action Mapping (Chat Commands)

## Why
Reliably translate conversational commands into flow actions with safety and traceability.

## Behavior
- Deterministic mapping from intents (submit trip, assign receipt, move receipt, approve/reject) to flow actions
- Safe re-execution: repeated commands do not create duplicate actions
- Retries/backoff for transient failures without duplicate sideâ€‘effects
- Audit linking: conversation context references the created/updated actions
- Ambiguous commands trigger clarification prompts before execution

## Scenarios (BDD)
Scenario: Submit trip via chat intent
Given a ready trip "Berlin May"
When the user says "Submit the Berlin trip"
Then a submission action is triggered exactly once
And the result is linked back to the conversation context

Scenario: Duplicate command is ignored safely
Given the user already submitted the trip
When the user repeats "Submit the Berlin trip"
Then no additional submission action is created
And the assistant replies that the trip is already submitted with a link to the audit


### Userflows

---

# E-011 Settlement & Reimbursement

## Intent
Handle reimbursement calculations, summaries, postings, and payouts.

## In-Scope
- PDF reimbursement summary
- FiBu posting export (DATEV/SAP)
- SEPA payroll/reimbursement
- Finance Role Dashboard (visibility: top-level tab when activeRole=Finance; deep link offers role-switch CTA)

## Out-of-Scope (optional)
- Detailed accounting UI (config in Admin)

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 PDF Summary
- R-002 FiBu Posting Export
- R-003 SEPA Reimbursement
 - R-004 Finance Role Dashboard


### Requirements

# R-001 Payment Summary PDF

## Why
Provide a payment overview PDF showing what needs to be paid to whom for finance team record keeping.

## Behavior
- **MVP Scope**: Only payment summary PDF (no other PDFs needed)
- **Content**: Payment overview showing what needs to be paid to whom
- **Format**: Clean, printable PDF with employee breakdowns
- **Access**: Available to Finance role users
- **Generation**: On-demand generation for payment cycles
- **Performance Target**: PDF generation completes in <15s p95; progress indicator shown

## Technical Requirements
- **PDF Content**: Employee list, amounts, bank details, payment dates
- **Format**: Professional layout suitable for finance records
- **File Size**: Optimized for email and storage (<2MB)
- **Access Control**: Finance role permission required
- **Audit Trail**: Track PDF generation and access
- **File Naming (Privacy)**: Filenames must not contain PII. Use pattern `payment_summary_<yyyymmdd-hhmm>_<digest8>.pdf`
- **Logging (Privacy)**: Mask PII fields in logs; include audit fields: userId, activeRole, action, entityId, timestamp; store file digest/hash

## Scenarios (BDD)
Scenario: Generate payment summary PDF
Given a finance user requests payment summary
When the PDF is generated
Then it shows all pending payments by employee
And includes amounts, bank details, and payment dates

Scenario: Finance role access control
Given a non-finance user tries to access payment PDF
When they attempt to generate the summary
Then access is denied
And an appropriate error message is shown

Scenario: PDF optimization for finance use
Given a payment summary PDF is generated
When the finance team receives it
Then the file size is under 2MB
And the layout is suitable for printing and record keeping

Scenario: PDF performance and privacy
Given a payment cycle with many employees
When the finance user requests PDF generation
Then the PDF completes within 15 seconds p95 with progress shown
And the filename follows `payment_summary_<yyyymmdd-hhmm>_<digest8>.pdf` without PII
And logs mask PII and include audit fields


# R-002 CSV Payment Export

## Why
Enable finance team to export payment proposals for manual bank processing with complete data accuracy and compliance tracking.

## Behavior
- **Export Generation**: Create CSV files with all required payment information
- **Data Validation**: Ensure all required fields are populated before export
- **Format Compliance**: Generate bank-compatible CSV format for upload systems
- **Access Control**: Restrict export functionality to Finance role users only
- **Audit Trail**: Track all export activities with user attribution and timestamp
- **Performance Targets**: Up to 10k rows export completes in <10s p95; progress indicator shown; queue long-running jobs

## Business Rules
- **Required Fields**: Employee ID, name, amount, currency, bank account, payment date
- **Data Validation**: All required fields must be populated before export allowed
- **File Naming (Privacy)**: Filenames must not contain PII. Use pattern `payments_<yyyymmdd-hhmm>_<digest8>.csv`
- **Logging (Privacy)**: Mask PII fields in logs; include audit fields: userId, activeRole, action, entityId, timestamp; store file digest/hash
- **Access Control**: Only Finance role users can access export functionality
- **Export Handling**: Large exports are split into manageable files
- **Data Accuracy**: Export must reflect current payment status at time of generation

## Scenarios (BDD)
Scenario: Export payment CSV for bank processing
Given a finance user requests payment export
When the CSV is generated
Then it contains all pending payments in bank-compatible format
And includes employee, amount, and bank details
And the file is named with date and cycle identifier
And the export is logged in the audit trail

Scenario: CSV validation and completeness
Given a payment CSV is generated
When the finance team reviews the file
Then all required fields are populated
And the format is compatible with bank upload systems
And the total amounts match the system totals
And any validation warnings are clearly displayed

Scenario: Finance role access control
Given a non-finance user tries to export payments
When they attempt to access the export function
Then access is denied
And an appropriate error message is shown
And the access attempt is logged in the audit trail
And guidance is provided on how to request access

Scenario: Large dataset export handling
Given more than 10,000 payments need to be exported
When the finance user requests export
Then the system creates multiple CSV files
And each file is properly named and numbered
And a summary file lists all generated files
And the user is informed of the multi-file export

Scenario: Export with data validation errors
Given some payments have validation issues
When the finance user attempts to export
Then validation errors are clearly displayed
And the export is blocked until issues are resolved
And specific guidance is provided on how to fix each issue
And the user can see which payments are affected

Scenario: Export performance and privacy
Given a dataset of up to 10,000 rows
When the finance user requests export
Then the export completes within 10 seconds p95 with progress shown
And the filename follows `payments_<yyyymmdd-hhmm>_<digest8>.csv` without PII
And logs mask PII and include audit fields


# R-003 Finance Role Dashboard

## Why
Provide finance team with comprehensive overview of pending payments, statistics, and export capabilities.

## Behavior
- **MVP Scope**: Finance role dashboard with payment overview and statistics
- **Dashboard Features**: Payment overview by employee, currency breakdown, due dates
- **Export Capabilities**: CSV export for bank upload, PDF payment summary
- **Statistics**: Payment trends, processing metrics, compliance rates
- **Access Control**: Finance role permission required

## Technical Requirements
- **Dashboard Layout**: Clean, organized view of payment information
- **Real-time Data**: Current payment status and amounts
- **Export Functions**: CSV and PDF generation capabilities
- **Statistics Display**: Charts and metrics for payment analysis
- **Responsive Design**: Works on desktop and mobile devices
- **Permission System**: Finance role access control

## Scenarios (BDD)
Scenario: Finance user accesses payment dashboard
Given a finance user logs into the system
When they navigate to the finance dashboard
Then they see payment overview by employee and urgency
And can access export functions and statistics

Scenario: Generate payment exports from dashboard
Given a finance user is on the dashboard
When they request CSV export or PDF summary
Then the appropriate file is generated
And includes all pending payment information

Scenario: View payment statistics and trends
Given a finance user accesses the dashboard
When they review the statistics section
Then they see payment trends and processing metrics
And can identify areas for process improvement


# R-004 Finance Role Dashboard

## Why
Provide Finance team with comprehensive overview of pending payments, statistics, and export capabilities in a dedicated dashboard.

## Behavior
- **User Role**: Finance role with dedicated dashboard access
- **Dashboard Features**: Payment overview by employee, currency breakdown, due dates, urgency indicators
- **Export Capabilities**: CSV export for bank upload, PDF payment summary generation
- **Statistics Display**: Payment trends, processing metrics, compliance rates, employee summaries
- **Access Control**: Finance role permission required for all dashboard functions
- **Real-time Data**: Current payment status and amounts updated in real-time

## Technical Requirements
- **Dashboard Layout**: Clean, organized view with intuitive navigation
- **Data Visualization**: Charts and metrics for payment analysis
- **Export Functions**: CSV and PDF generation with proper formatting
- **Responsive Design**: Works seamlessly on desktop and mobile devices
- **Permission System**: Finance role access control with audit logging
- **Performance**: Dashboard loads in <2 seconds with real-time updates

## Dashboard Sections

### Payment Overview
- Employee list with pending payment amounts
- Currency breakdown (EUR vs. other currencies)
- Payment due dates and urgency indicators
- Status tracking (approved, pending, processing)

### Export Functions
- CSV export for bank upload systems
- PDF payment summary for records
- Bulk export capabilities for multiple payment cycles
- Export history and audit trail

### Statistics & Analytics
- Monthly payment trends and patterns
- Average reimbursement amounts by employee
- Processing time metrics and bottlenecks
- Policy compliance rates and violations
- Cost analysis and budget tracking

### Employee Management
- Per-employee payment summaries
- Receipt count and categorization
- Approval status and manager sign-off
- Payment history and audit trail

## Visibility & Navigation
- Visible only to users with Finance role. When activeRole=Finance, Finance appears as a top-level tab (replaces Chat) for the session; otherwise, reachable under Settings â†’ Finance.
- Deep link handling: If a user with Finance role opens a Finance URL while another role is active, show 403 card with CTA to switch to Finance.

## Scenarios (BDD)
Scenario: Finance user accesses comprehensive dashboard
Given a Finance role user logs into the system
When they navigate to the Finance dashboard
Then they see payment overview, statistics, and export options
And all data is current and accurate

Scenario: Generate payment exports from dashboard
Given a Finance user is on the dashboard
When they request CSV export or PDF summary
Then the appropriate file is generated with all payment data
And includes proper formatting for bank systems

Scenario: View payment statistics and trends
Given a Finance user accesses the dashboard
When they review the statistics section
Then they see comprehensive payment trends and metrics
And can identify areas for process improvement

Scenario: Role-based access control
Given a non-Finance user tries to access the dashboard
When they attempt to navigate to Finance features
Then access is denied with appropriate error message
And the attempt is logged in the audit trail

## Scenarios (BDD) â€” visibility
Scenario: Deep link offers Finance role switch
Given a user has Finance role but active role is Traveler
When they open `/finance/dashboard`
Then a 403 card is shown with CTA "Switch to Finance"
And selecting it switches role and opens the dashboard


### Userflows

# UF-011 Conversational Settlement: PDF, Export & Payout Status (Chat)

## Scope
- Epic: `E-011-settlement-reimbursement`
- Goal: Let users request PDFs, check payout status, and trigger finance actions (role-gated) via chat.
- Entry: User opens Chat and asks "Send me the PDF", "Whatâ€™s the payout status?", or Finance asks to export/SEPA.
- Exit: PDF delivered or status shown; finance actions queued or executed with confirmation.

## Personas & Context
- Traveler (PDF, status); Finance (exports, SEPA); Manager (read-only status).

## Flow (numbered)
1) Traveler: "Send me the PDF for Berlin trip"
   - System: Generates PDF; posts a download link and optional email/share buttons; logs audit reference.
2) Traveler: "Email the PDF to my manager"
   - System: Confirms target recipient; sends email; posts confirmation with message ID.
3) Traveler: "Whatâ€™s the payout status?"
   - System: Returns status (e.g., Pending Finance, Exported, In SEPA batch, Paid on YYYYâ€‘MMâ€‘DD) with reference IDs.
4) Finance: "Export DATEV for approved items"
   - System: Checks role; asks for date range/filters; confirms action; triggers export job; posts job started message with progress updates.
5) Finance: "Generate SEPA for batch 2025â€‘W32"
   - System: Checks role; validates IBAN/amounts; asks for confirmation; generates SEPA; posts result and file link.
6) Errors
   - System: Inline error with reference code; retries allowed; idempotency to avoid duplicate exports.

## Screens & States
- Screen: Chat Home (Settlement context)
  - Loading: Skeleton bubbles for job updates
  - Empty: Prompt suggestions: "Send me the PDF", "Payout status?"
  - Error: Inline error bubble; retry
  - Validation: Role/permission checks for Finance actions; confirmations before irreversible actions
- Screen: Export Job Panel (optional)
  - Loading: Job progress (queued/running/completed)
  - Empty: No jobs yet
  - Error: Job failure details; link to logs

## Navigation
- Chat â†’ PDF preview/download (new tab or in-app viewer)
- Chat â†’ Export Job Panel for progress; back returns to chat

## Components & Tokens
- Components: LLMChatBubble, Button, StatusBadge, ProgressBar, Link, Toast
- Tokens: E-002 tokens; status colors; clear affordances

## Accessibility & Responsiveness
- A11y: Links and buttons have descriptive labels; job updates announced via aria-live; role errors include guidance
- Breakpoints: Mobile-friendly file link actions; desktop shows side panel for job details

## Telemetry (optional)
- Events: chat_pdf_requested, chat_pdf_emailed, chat_payout_status_requested, chat_export_job_started, chat_export_job_completed, chat_sepa_generated, chat_settlement_error


# UF-011 Settlement: PDF Summary and SEPA Export

## Scope
- Epic: `E-011-settlement-reimbursement`
- Goal: Allow Finance to generate PDF payment summaries and SEPA exports.
- Entry: Finance opens the Finance dashboard or follows a deep link.
- Exit: PDF/SEPA file generated and downloaded; audit entry recorded.

## Personas & Context
- Finance role only. Access controlled by RBAC.

## Flow (numbered)
1) Finance opens Finance dashboard (top-level tab when `activeRole=Finance`; otherwise via Settings â†’ Finance)
   - System: Shows payment overview with export actions.
2) Finance selects "Export CSV (bank)" or "Generate PDF summary"
   - System: Generates the selected file; shows progress; downloads on completion.
3) Deep link guard
   - If active role is not Finance and user opens `/finance/dashboard`, System shows 403 card with CTA "Switch to Finance"; on confirm, switches role and opens dashboard.
4) Audit
   - System records audit with userId, `activeRole`, action, entityId, timestamp.

## Screens & States
- Screen: Finance Dashboard
  - Loading: Skeleton charts and tables
  - Empty: "No pending payments"
  - Error: Export failed; Retry
  - Validation: Permission check; hide actions for non-Finance

## Navigation
- Finance dashboard â†’ Export history â†’ back preserves filters

## Components & Tokens
- Components: DashboardHeader, ExportButtons, Table, Chart, Toast
- Tokens: E-002 tokens; clear affordances for export actions

## Accessibility & Responsiveness
- A11y: Buttons labeled; announce download start/complete via aria-live
- Breakpoints: Desktop-first dashboard; mobile tables stack; charts responsive

## Telemetry (optional)
- Events: finance_dashboard_opened, export_csv_clicked, export_pdf_clicked, export_completed, export_failed, role_switch_cta_shown, role_switch_cta_accepted


# UF-011 Wireframes â€” Finance Dashboard & Exports

## Scope
- Epic: `E-011-settlement-reimbursement`
- Goal: Show Finance dashboard layout and export interactions.

## Desktop â€” Finance Dashboard (activeRole=Finance)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ Finance Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Export CSV] [Generate PDF]       â”‚ KPIs          â”‚
â”‚                                    â”‚ â€¢ Pending     â”‚
â”‚ Chart: Monthly Trends              â”‚ â€¢ Total â‚¬     â”‚
â”‚                                    â”‚ â€¢ SLA %       â”‚
â”‚ Table: Pending Payments            â”‚               â”‚
â”‚  Employee   Amount   Due   Status  â”‚               â”‚
â”‚  Alice      â‚¬243.20  Today  Ready  â”‚               â”‚
â”‚  Bob        â‚¬118.50  Tomorrow Warn â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Actions top-right; table sortable; chart responsive

## Mobile â€” Finance Dashboard
```
â”Œâ”€â”€ KPIs â”€â”€â”
â”‚ Pending  â”‚  [Export CSV]
â”‚ Total â‚¬  â”‚  [Generate PDF]
â”‚ SLA %    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
[Chart]
[Table]
```
- Actions stacked; tables become cards

## Export Progress & Result
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Generating CSVâ€¦  82%   â”‚
â”‚ [Cancel]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Toast: "CSV exported"  [Download]
```
- Audit on completion with userId, activeRole, action

## 403 Card with Role-Switch CTA (deep link)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 403: Not allowed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ You need Finance role to access the dashboard.   â”‚
â”‚ [Switch to Finance]   [Cancel]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## States
- Loading: Skeleton charts/tables
- Empty: "No pending payments"
- Error: Export failed â†’ Retry
- Validation: Hide actions for non-Finance

## Components
- DashboardHeader, ExportButtons, KPIGroup, Chart, Table, Toast, 403Card

## Accessibility
- Buttons labeled; aria-live for download start/complete

## Telemetry
- finance_dashboard_opened, export_csv_clicked, export_pdf_clicked, export_completed, export_failed, role_switch_cta_shown, role_switch_cta_accepted


---

# E-012 Admin & Configuration

## Intent
Provide administrative configuration for perâ€‘diems, policy, and access control.

## In-Scope
- Perâ€‘diem management UI (versioned, effectiveâ€‘dated)
- Policy configuration UI (import/export/versioning)
- Roles & permissions
- Approvals SLA settings (business days)

## Out-of-Scope (optional)
- Runtime policy engine (covered elsewhere)
- Readyâ€‘fields editor UI (post-MVP)
- Monitoring dashboard (post-MVP)

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 Perâ€‘Diem Management UI
- R-002 Policy Config UI
- R-003 Roles & Permissions
- R-004 Approvals SLA Settings


### Requirements

# R-001 Perâ€‘Diem Management UI

## Why
Allow Finance Administrators to maintain versioned, effective-dated per-diem rates through an intuitive guided interface that ensures data accuracy and compliance.

## Behavior
- **User Persona**: Finance Administrator (Medium-High technical skill)
- **Interface**: Guided setup wizard with progressive disclosure and validation
- **Functionality**: Edit versioned, effective-dated per-diem tables with rollback capability
- **Validation**: Real-time validation against required fields, formats, and business rules
- **Audit**: Track change history with complete audit trail and user attribution
- **Setup Time**: Target <30 minutes for new admin configuration

## Business Rules
- **Rate Validation**: Per-diem rates must be within acceptable business ranges
- **Effective Dating**: Rate changes must have clear effective dates with no gaps
- **Version Control**: All rate changes create new versions with rollback capability
- **Business Logic**: Rate changes must not violate company policy or compliance rules
- **Approval Workflow**: Significant rate changes may require additional approval
- **Data Integrity**: Prevent overlapping effective dates and conflicting rate structures

## Scenarios (BDD)
Scenario: New admin completes per-diem setup
Given a new Finance Administrator starts configuration
When they follow the guided setup wizard
Then per-diem rates are configured in under 30 minutes
And validation ensures data accuracy
And the setup is logged in the audit trail
And the admin receives confirmation of successful setup

Scenario: Update effective-dated rate with audit
Given an admin edits a per-diem rate
When saving a new effective date
Then the rate is stored with the new effective date
And the change is recorded in history with user attribution
And the new rate is immediately available for calculations
And stakeholders are notified of the rate change

Scenario: Bulk import with validation
Given an admin uploads a CSV file with per-diem rates
When the system processes the import
Then validation errors are shown in real-time
And successful imports are applied with audit trail
And the admin can review and approve the changes
And any conflicts with existing rates are highlighted

Scenario: Rate change with business rule validation
Given an admin attempts to set a rate outside acceptable range
When the validation runs
Then the change is blocked
And clear explanation of the business rule violation is provided
And guidance is given on acceptable rate ranges
And the admin can adjust the rate accordingly

Scenario: Rate rollback to previous version
Given a per-diem rate change causes issues
When the admin requests a rollback
Then the system reverts to the previous version
And the rollback is logged in the audit trail
And all affected calculations are updated
And stakeholders are notified of the rollback


# R-002 Policy Config UI

## Why
Enable Finance Administrators to configure policy rules through import/export with versioning and validation.

## Behavior
- **User Persona**: Finance Administrator (Medium-High technical skill)
- **Interface**: Guided setup wizard with progressive disclosure
- **Functionality**: Import/export policy definitions with versioning
- **Validation**: Real-time validation of coverage and conflicts
- **Rollback**: Version management with rollback capability
- **Setup Time**: Target <30 minutes for new admin configuration

## Technical Requirements
- **Import/Export**: Support for multiple file formats (JSON, CSV, XML)
- **Version Management**: Complete version history with rollback functionality
- **Validation Engine**: Real-time policy validation and conflict detection
- **Template System**: Pre-built policy templates for common scenarios
- **Bulk Operations**: Batch import/export for large policy sets
- **Audit Trail**: Complete change history with user attribution

## Scenarios (BDD)
Scenario: Import policy configuration with validation
Given an admin has a valid policy file
When importing it through the guided interface
Then the policy is validated for coverage and conflicts
And applied with versioning and rollback capability

Scenario: Policy version management and rollback
Given multiple policy versions exist
When an admin needs to rollback to a previous version
Then the rollback process is completed safely
And all changes are tracked in the audit trail

Scenario: Template-based policy setup
Given a new admin is configuring policies
When they select a template for their industry
Then the template is applied with customization options
And validation ensures all required fields are completed


# R-003 Roles & Permissions

## Why
Control access to administrative features based on user roles and responsibilities while maintaining security and audit compliance.

## Behavior
- **User Personas**: Three distinct admin roles with specific permissions and access levels
- **Role Management**: Define roles and assign permissions to actions with clear boundaries
- **Permission Enforcement**: Enforce permissions across admin UI and functions consistently
- **Audit Trail**: Complete audit of role changes and permission updates with user attribution
- **Setup Time**: Target <30 minutes for new admin configuration

## Admin User Personas & Permissions

### Finance Administrator
- **Permissions**: Per-diem management, policy configuration, approval workflows, finance dashboard access
- **Access**: Finance dashboard, payment exports, policy editor, per-diem tables
- **Skill Level**: Medium-High technical skill
- **Business Scope**: Financial policies, rates, and payment processing

### IT Administrator
- **Permissions**: User management, system configuration, monitoring, security settings
- **Access**: User roles, system settings, performance metrics, security logs
- **Skill Level**: High technical skill
- **Business Scope**: System administration and user access management

## Business Rules
- **Role Hierarchy**: IT Administrator > Finance Administrator
- **Permission Inheritance**: Higher roles inherit permissions from lower roles
- **Access Validation**: Verify user permissions on each function access
- **Change Approval**: Significant permission changes require approval workflow
- **Audit Requirements**: All permission changes logged with business justification

## MVP Simplification
- Application roles emphasized for MVP: Traveler, Manager, Finance, IT Administrator.
- Admin personas for MVP: IT Administrator and Finance Administrator only (Department Manager removed).
- Finance Administrator capabilities limited to Finance role surfaces (dashboard, exports) in MVP; IT Administrator owns user/role management.

## Scenarios (BDD)
Scenario: Finance Administrator accesses per-diem management
Given a user with Finance Administrator role
When they navigate to the admin section
Then they see per-diem and policy management options
And can access finance dashboard features
And are restricted from IT administration functions
And their access is logged in the audit trail

Scenario: Permission prevents unauthorized access
Given a user without Admin role
When visiting the Admin page
Then access is denied with a clear message
And appropriate error handling is shown
And the access attempt is logged for security review
And guidance is provided on how to request access

Scenario: Role-based UI customization
Given different admin users log in
When they access the admin interface
Then they see only relevant features for their role
And navigation is customized to their permissions
And role-specific help and guidance is displayed
And their access level is clearly indicated

Scenario: Permission change with approval workflow
Given an admin requests elevated permissions
When the change is significant
Then an approval workflow is triggered
And the request is reviewed by appropriate stakeholders
And the change is logged with business justification
And the user is notified of the approval decision

Scenario: Role delegation and backup
Given a primary admin is unavailable
When backup admin access is needed
Then temporary role delegation can be granted
And the delegation is time-limited and audited
And the primary admin is notified of the delegation
And normal access is restored when the primary admin returns

## Scenarios (BDD) â€” MVP roles
Scenario: Only IT Administrator can manage users/roles
Given a Finance user without IT Administrator role
When they open Settings â†’ Admin
Then access is denied with a clear message
And guidance is provided on how to request access


# R-004 Approvals SLA Settings

## Why
Allow Finance Administrators to configure approval inactivity thresholds through an intuitive guided interface.

## Behavior
- **User Persona**: Finance Administrator (Medium-High technical skill)
- **Interface**: Guided setup wizard with progressive disclosure
- **Setting**: Approval inactivity SLA (business days) with sensible defaults and guardrails
- **Calendar Basis**: Business-day calendar (weekends excluded); holiday handling out of scope for MVP
- **Applies To**: `E-007 Approvals / R-003 Delegation on Inactivity`
- **Effect Timing**: Changes apply promptly to new and existing tasks
- **Audit**: Complete audit trail with user, timestamp, old â†’ new value
- **Setup Time**: Target under 30 minutes for new admin configuration

## Scenarios (BDD)
Scenario: Finance Administrator updates SLA through guided interface
Given a Finance Administrator with permissions
When they use the guided SLA configuration wizard
Then the SLA is changed to a new value in business days
And new and existing approval tasks reflect the new SLA
And an audit entry records the change with user attribution

Scenario: SLA validation and business day calculation
Given an admin sets a new SLA
When the system processes the change
Then validation ensures the value is within allowable range
And business day calculation excludes weekends automatically

Scenario: Real-time SLA application
Given an SLA change is made
When the system processes the update
Then existing approval tasks are updated promptly
And new tasks immediately use the new SLA value


### Userflows

# UF-012 Admin: Perâ€‘Diems, Policy Config & Roles

## Scope
- Epic: `E-012-admin-configuration`
- Goal: Allow admins to manage perâ€‘diems, import/export policy configs with versioning/rollback, and control roles/permissions.
- Entry: Admin opens Admin section.
- Exit: Changes saved with audit; permissions enforced.

## Personas & Context
- Admin role only.

## Flow (numbered)
1) Admin opens Admin Home
   - System: Shows tabs: Perâ€‘Diems, Policy, Roles.
2) Perâ€‘Diems tab
   - Admin edits a rate row effective 2025â€‘10â€‘01; System validates fields; on save, new version stored with audit; success toast.
3) Policy tab
   - Admin clicks Import; selects policy.json; System validates coverage/conflicts; on success creates new version with rollback option; shows diff summary.
4) Roles tab
   - Admin assigns "Finance" role to user X; System updates permissions; logs audit event; restricted pages reflect new access.

## Screens & States
- Screen: Admin â€“ Perâ€‘Diems
  - Loading: Table skeleton
  - Empty: No rows â†’ CTA to add first rate
  - Error: Save/validate error with details; no partial commits
  - Validation: Effectiveâ€‘dated constraints; required columns
- Screen: Admin â€“ Policy Config
  - Loading: Version list
  - Empty: No versions yet
  - Error: Import failed â†’ show errors; allow download of error report
  - Validation: Block apply if conflicts; enable rollback
- Screen: Admin â€“ Roles
  - Loading: Users/roles list
  - Empty: No assignments
  - Error: Update failed â†’ retry
  - Validation: Enforce permission checks across app

## Navigation
- Admin â†’ Perâ€‘Diems / Policy / Roles tabs
- Version history detail â†’ rollback confirmation dialog

## Components & Tokens
- Components: Tabs, Table, Dialog, Upload, DiffViewer, RoleSelector, Toast
- Tokens: E-002 tokens; semantic colors for add/change/remove; clear focus rings

## Accessibility & Responsiveness
- A11y: Tables with headers and summaries; dialogs labeled; keyboard navigation across cells
- Breakpoints: Tables collapse columns; actions move into kebab menus on small screens

## Telemetry (optional)
- Events: admin_perdiem_save, policy_import_start/success/fail, policy_rollback, role_update_success/fail


---

# E-013 Measurement & Telemetry

## Intent
Measure real user performance and usage safely to guide improvements (post-MVP).

## In-Scope
- UX Telemetry (RUM) for core web vitals and route timings
- Anonymized session/log IDs attached to feedback
- Tenant-level opt-out control

## Out-of-Scope (optional)
- Product features blocked by telemetry

## Requirements
- See structure and naming in `Workflow/Conventions.md`.
- Reference list (optional):
- R-001 UX Telemetry (RUM)


### Requirements

# R-001 UX Telemetry (RUM)

## Why
Measure real user performance and usage to improve UX.

## Behavior
- Capture core web vitals and route timings
- Attach anonymized session/log IDs to feedback
- Opt-out setting per tenant

## Scenarios (BDD)
Scenario: Route timing is recorded
Given telemetry is enabled
When the user navigates to /review
Then route timing is sent with anonymized session ID


### Userflows

---